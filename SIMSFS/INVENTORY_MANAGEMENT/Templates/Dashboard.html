{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% csrf_token %}
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Dashboard - Complete</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      --primary: #1abc9c;
      --secondary: #3498db;
      --dark: #2c3e50;
      --gray: #7f8c8d;
      --light-gray: #ecf0f1;
      --white: #ffffff;
      --success: #2ecc71;
      --warning: #f39c12;
      --error: #e74c3c;
      --purple: #9b59b6;
      --orange: #e67e22;
      --navy: #021640;
      --info: #3498db;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f7fa;
      color: var(--dark);
    }
    
    .dashboard-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .dashboard-header {
      margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: var(--dark);
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .dashboard-header p {
      color: var(--gray);
      font-size: 1.05rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: 10px;
      padding: 17px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.5s, box-shadow 0.5s;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: var(--primary);
    }
    
    .stat-icon {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
    }
    
    .stat-icon.primary { background: linear-gradient(135deg, #d1f2eb 0%, var(--primary) 100%); color: #16a085; }
    .stat-icon.secondary { background: linear-gradient(135deg, #e3f2fd 0%, var(--secondary) 100%); color: #1565c0; }
    .stat-icon.success { background: linear-gradient(135deg, #e8f5e9 0%, var(--success) 100%); color: #2e7d32; }
    .stat-icon.warning { background: linear-gradient(135deg, #fff3e0 0%, var(--warning) 100%); color: #e65100; }
    .stat-icon.error { background: linear-gradient(135deg, #ffebee 0%, var(--error) 100%); color: #c62828; }
    .stat-icon.purple { background: linear-gradient(135deg, #f3e5f5 0%, var(--purple) 100%); color: #6a1b9a; }
    .stat-icon.orange { background: linear-gradient(135deg, #fff3e0 0%, var(--orange) 100%); color: #d84315; }
    .stat-icon.navy { background: linear-gradient(135deg, #e3f2fd 0%, var(--navy) 100%); color: var(--navy); }
    .stat-icon.info { background: linear-gradient(135deg, #e1f5fe 0%, var(--info) 100%); color: #01579b; }
    
    .stat-content { flex: 1; }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark);
      font-family: 'Montserrat', sans-serif;
    }
    
    .stat-value.small {
      font-size: 1.3rem;
    }
    
    .stat-change {
      font-size: 0.85rem;
      margin-top: 5px;
      color: var(--gray);
    }
    
    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--error); }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .chart-card {
      background: var(--white);
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .chart-card.wide { grid-column: span 2; }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .chart-title {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.3rem;
    }
    
    .chart-subtitle {
      color: var(--gray);
      font-size: 0.9rem;
      margin-top: 5px;
    }
    
    .chart-container {
      position: relative;
      height: 350px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .table-card {
      background: var(--white);
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .table-title {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.3rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background-color: var(--dark);
      color: var(--white);
      padding: 12px 15px;
      text-align: left;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--light-gray);
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .data-table tr:hover {
      background-color: rgba(26, 188, 156, 0.05);
    }
    
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      text-transform: uppercase;
    }
    
    .status-badge.completed { background-color: #d4edda; color: #155724; }
    .status-badge.pending { background-color: #fff3cd; color: #856404; }
    .status-badge.partial { background-color: #d1ecf1; color: #0c5460; }
    .status-badge.partial-payment { background-color: #d1ecf1; color: #0c5460; }
    .status-badge.processing { background-color: #e7f3ff; color: #004085; }
    .status-badge.delivered { background-color: #d4edda; color: #155724; }
    .status-badge.reorder { background-color: #f8d7da; color: #721c24; }
    .status-badge.in-transit { background-color: #d1ecf1; color: #0c5460; }
    .status-badge.dispatched { background-color: #cce5ff; color: #004085; }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid var(--light-gray);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 1200px) {
      .charts-grid { grid-template-columns: 1fr; }
      .chart-card.wide { grid-column: span 1; }
    }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .chart-container { height: 250px; }
      .dashboard-header h1 { font-size: 1.5rem; }
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1><i class="fas fa-tachometer-alt"></i> Business Dashboard</h1>
      <p>Complete real-time overview of your business operations</p>
    </div>
    
    <!-- 10 KPI Cards -->
    <div class="stats-grid">
      <!-- Card 1: Inventory Cost Value -->
      <div class="stat-card">
        <div class="stat-icon primary"><i class="fas fa-boxes"></i></div>
        <div class="stat-content">
          <div class="stat-label">Inventory Cost Value</div>
          <div class="stat-value" id="inventoryCostValue">KSH 0.00</div>
          <div class="stat-change" id="inventoryCostChange">At purchase price</div>
        </div>
      </div>
      
      <!-- Card 2: Potential Revenue -->
      <div class="stat-card">
        <div class="stat-icon info"><i class="fas fa-hand-holding-usd"></i></div>
        <div class="stat-content">
          <div class="stat-label">Potential Revenue</div>
          <div class="stat-value" id="potentialRevenue">KSH 0.00</div>
          <div class="stat-change" id="potentialProfit">Potential profit</div>
        </div>
      </div>
      
      <!-- Card 3: Total Sales -->
      <div class="stat-card">
        <div class="stat-icon success"><i class="fas fa-chart-line"></i></div>
        <div class="stat-content">
          <div class="stat-label">Total Sales</div>
          <div class="stat-value" id="totalSales">KSH 0.00</div>
          <div class="stat-change" id="salesChange">Loading...</div>
        </div>
      </div>
      
      <!-- Card 4: Total Purchases -->
      <div class="stat-card">
        <div class="stat-icon secondary"><i class="fas fa-shopping-cart"></i></div>
        <div class="stat-content">
          <div class="stat-label">Total Purchases</div>
          <div class="stat-value" id="totalPurchases">KSH 0.00</div>
          <div class="stat-change" id="purchasesChange">Loading...</div>
        </div>
      </div>
      
      <!-- Card 5: Net Profit -->
      <div class="stat-card">
        <div class="stat-icon navy"><i class="fas fa-piggy-bank"></i></div>
        <div class="stat-content">
          <div class="stat-label">Net Profit</div>
          <div class="stat-value" id="netProfit">KSH 0.00</div>
          <div class="stat-change" id="profitMargin">Loading...</div>
        </div>
      </div>
      
      <!-- Card 6: Receivables -->
      <div class="stat-card">
        <div class="stat-icon warning"><i class="fas fa-hand-holding-usd"></i></div>
        <div class="stat-content">
          <div class="stat-label">Receivables</div>
          <div class="stat-value" id="totalReceivables">KSH 0.00</div>
          <div class="stat-change" id="receivablesChange">Loading...</div>
        </div>
      </div>
      
      <!-- Card 7: Payables -->
      <div class="stat-card">
        <div class="stat-icon error"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="stat-content">
          <div class="stat-label">Payables</div>
          <div class="stat-value" id="totalPayables">KSH 0.00</div>
          <div class="stat-change" id="payablesChange">Loading...</div>
        </div>
      </div>
      
      <!-- Card 8: Reorder Required -->
      <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-content">
          <div class="stat-label">Reorder Required</div>
          <div class="stat-value" id="reorderItems">0</div>
          <div class="stat-change negative">Items below minimum</div>
        </div>
      </div>
      
      <!-- Card 9: Top Selling Item -->
      <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-trophy"></i></div>
        <div class="stat-content">
          <div class="stat-label">Top Selling Item</div>
          <div class="stat-value small" id="topSellingItem">Loading...</div>
          <div class="stat-change positive" id="topItemCategory">Category & Type</div>
        </div>
      </div>
      
      <!-- Card 10: Top Sales Location -->
      <div class="stat-card">
        <div class="stat-icon info"><i class="fas fa-map-marker-alt"></i></div>
        <div class="stat-content">
          <div class="stat-label">Top Sales Location</div>
          <div class="stat-value" id="topSalesLocation">Loading...</div>
          <div class="stat-change positive" id="topLocationAmount">By county</div>
        </div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-header">
          <div>
            <div class="chart-title">Overall Sales Trend</div>
            <div class="chart-subtitle">Monthly sales performance</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="salesTrendChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Sales by Location</div>
            <div class="chart-subtitle">Revenue by county</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="salesLocationChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Sales by Category</div>
            <div class="chart-subtitle">By item type</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="salesCategoryChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Purchases by Location</div>
            <div class="chart-subtitle">Spending by county</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="purchasesLocationChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Purchases by Category</div>
            <div class="chart-subtitle">By item type</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="purchasesCategoryChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Payment Status</div>
            <div class="chart-subtitle">Orders by status</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="paymentStatusChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Top 5 Customers</div>
            <div class="chart-subtitle">By total sales</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="topCustomersChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Tables -->
    <div class="tables-grid">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">
            <i class="fas fa-exclamation-circle" style="color: var(--error);"></i>
            Items Requiring Reorder
          </div>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Item ID</th>
              <th>Item Name</th>
              <th>Category</th>
              <th>Current Stock</th>
              <th>Reorder Level</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="lowStockTable">
            <tr><td colspan="6" style="text-align: center; padding: 30px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">
            <i class="fas fa-receipt" style="color: var(--success);"></i>
            Recent Sales Orders
          </div>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>SO ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Receipt Status</th>
              <th>Shipping Status</th>
            </tr>
          </thead>
          <tbody id="recentSalesTable">
            <tr><td colspan="6" style="text-align: center; padding: 30px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">
            <i class="fas fa-shopping-bag" style="color: var(--secondary);"></i>
            Recent Purchase Orders
          </div>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>PO ID</th>
              <th>Date</th>
              <th>Supplier</th>
              <th>Amount</th>
              <th>Payment Status</th>
              <th>Shipping Status</th>
            </tr>
          </thead>
          <tbody id="recentPurchasesTable">
            <tr><td colspan="6" style="text-align: center; padding: 30px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <script>
    console.log('ðŸš€ Complete Dashboard Loading...');
    
    let dashboardData = {
      inventory: [],
      sales: [],
      purchases: [],
      customers: [],
      suppliers: [],
      salesDetails: [],
      purchaseDetails: []
    };
    
    let charts = {};
    
    function getCSRFToken() {
      const metaTag = document.querySelector('meta[name="csrf-token"]');
      if (metaTag) return metaTag.getAttribute('content');
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
      }
      return null;
    }
    
    function formatNumber(num) {
      if (isNaN(num)) return '0.00';
      return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    function formatToThousands(num) {
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toFixed(0);
    }
    
    function parseDate(dateStr) {
      if (!dateStr) return new Date();
      const [day, month, year] = dateStr.split('/');
      return new Date(year, month - 1, day);
    }
    
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸ“Š Initializing complete dashboard...');
      loadAllData();
    });
    
    async function loadAllData() {
      showLoading();
      try {
        await Promise.all([
          loadInventory(),
          loadSales(),
          loadPurchases(),
          loadCustomers(),
          loadSuppliers()
        ]);
        
        await Promise.all([
          loadSalesDetails(),
          loadPurchaseDetails()
        ]);
        
        console.log('âœ… All data loaded');
        console.log('- Inventory:', dashboardData.inventory.length);
        console.log('- Sales:', dashboardData.sales.length);
        console.log('- Purchases:', dashboardData.purchases.length);
        console.log('- Customers:', dashboardData.customers.length);
        console.log('- Suppliers:', dashboardData.suppliers.length);
        console.log('- Sales Details:', dashboardData.salesDetails.length);
        console.log('- Purchase Details:', dashboardData.purchaseDetails.length);
        
        calculateKPIs();
        renderCharts();
        renderTables();
        
        console.log('âœ… Dashboard complete!');
      } catch (error) {
        console.error('âŒ Error:', error);
        alert('Error loading dashboard. Please check console.');
      } finally {
        hideLoading();
      }
    }
    
    async function loadInventory() {
      const response = await fetch('/api/inventory/all/', {
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const result = await response.json();
      dashboardData.inventory = result.success ? (result.data || []) : [];
    }
    
    async function loadSales() {
      const response = await fetch('/api/sales/', {
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const result = await response.json();
      dashboardData.sales = result.success ? (result.data || []) : [];
    }
    
    async function loadPurchases() {
      const response = await fetch('/api/purchases/', {
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const result = await response.json();
      dashboardData.purchases = result.success ? (result.data || []) : [];
    }
    
    async function loadCustomers() {
      const response = await fetch('/api/customers/', {
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const result = await response.json();
      dashboardData.customers = result.success ? (result.data || []) : [];
    }
    
    async function loadSuppliers() {
      const response = await fetch('/api/suppliers/', {
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        credentials: 'same-origin'
      });
      const result = await response.json();
      dashboardData.suppliers = result.success ? (result.data || []) : [];
    }
    
    async function loadSalesDetails() {
      try {
        const response = await fetch('/api/dashboard/sales-details/', {
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
          credentials: 'same-origin'
        });
        const result = await response.json();
        dashboardData.salesDetails = result.success ? (result.data || []) : [];
      } catch (error) {
        console.warn('âš ï¸ Sales details not available:', error);
        dashboardData.salesDetails = [];
      }
    }
    
    async function loadPurchaseDetails() {
      try {
        const response = await fetch('/api/dashboard/purchase-details/', {
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
          credentials: 'same-origin'
        });
        const result = await response.json();
        dashboardData.purchaseDetails = result.success ? (result.data || []) : [];
      } catch (error) {
        console.warn('âš ï¸ Purchase details not available:', error);
        dashboardData.purchaseDetails = [];
      }
    }
    
    function calculateKPIs() {
      // 1. Inventory Cost Value (at purchase price - actual investment)
      const inventoryCostValue = dashboardData.inventory.reduce((sum, item) => {
        return sum + ((parseFloat(item.remainingQty) || 0) * (parseFloat(item.purchase_price) || 0));
      }, 0);
      document.getElementById('inventoryCostValue').textContent = 'KSH ' + formatNumber(inventoryCostValue);
      document.getElementById('inventoryCostChange').textContent = `${dashboardData.inventory.length} items | Cost basis`;
      
      // 2. Potential Revenue (at sale price - what you could earn if all sold)
      const potentialRevenue = dashboardData.inventory.reduce((sum, item) => {
        return sum + ((parseFloat(item.remainingQty) || 0) * (parseFloat(item.sale_price) || 0));
      }, 0);
      const potentialProfit = potentialRevenue - inventoryCostValue;
      const potentialMargin = inventoryCostValue > 0 ? ((potentialProfit / inventoryCostValue) * 100).toFixed(1) : 0;
      document.getElementById('potentialRevenue').textContent = 'KSH ' + formatNumber(potentialRevenue);
      const potentialProfitElement = document.getElementById('potentialProfit');
      potentialProfitElement.textContent = `KSH ${formatNumber(potentialProfit)} (${potentialMargin}% margin)`;
      potentialProfitElement.className = potentialProfit >= 0 ? 'stat-change positive' : 'stat-change negative';
      
      const inventoryValue = dashboardData.inventory.reduce((sum, item) => {
        return sum + ((parseFloat(item.remainingQty) || 0) * (parseFloat(item.sale_price) || 0));
      }, 0);
      document.getElementById('totalInventoryValue').textContent = 'KSH ' + formatNumber(inventoryValue);
      document.getElementById('inventoryChange').textContent = `${dashboardData.inventory.length} items in stock`;
      
      const totalSales = dashboardData.sales.reduce((sum, sale) => sum + (parseFloat(sale.total_amount) || 0), 0);
      document.getElementById('totalSales').textContent = 'KSH ' + formatNumber(totalSales);
      document.getElementById('salesChange').textContent = `${dashboardData.sales.length} sales orders`;
      
      const totalPurchases = dashboardData.purchases.reduce((sum, purchase) => sum + (parseFloat(purchase.total_amount) || 0), 0);
      document.getElementById('totalPurchases').textContent = 'KSH ' + formatNumber(totalPurchases);
      document.getElementById('purchasesChange').textContent = `${dashboardData.purchases.length} purchase orders`;
      
      const netProfit = totalSales - totalPurchases;
      const profitMargin = totalSales > 0 ? ((netProfit / totalSales) * 100).toFixed(1) : 0;
      document.getElementById('netProfit').textContent = 'KSH ' + formatNumber(netProfit);
      const profitMarginElement = document.getElementById('profitMargin');
      profitMarginElement.textContent = `Margin: ${profitMargin}%`;
      profitMarginElement.className = netProfit >= 0 ? 'stat-change positive' : 'stat-change negative';
      
      const totalReceivables = dashboardData.customers.reduce((sum, customer) => sum + (parseFloat(customer.balance) || 0), 0);
      document.getElementById('totalReceivables').textContent = 'KSH ' + formatNumber(totalReceivables);
      document.getElementById('receivablesChange').textContent = `From ${dashboardData.customers.length} customers`;
      
      const totalPayables = dashboardData.suppliers.reduce((sum, supplier) => sum + (parseFloat(supplier.balance) || 0), 0);
      document.getElementById('totalPayables').textContent = 'KSH ' + formatNumber(totalPayables);
      document.getElementById('payablesChange').textContent = `To ${dashboardData.suppliers.length} suppliers`;
      
      const reorderItems = dashboardData.inventory.filter(item => item.reorderRequired === 'YES').length;
      document.getElementById('reorderItems').textContent = reorderItems;
    }
    
    function renderCharts() {
      console.log('ðŸ“Š Rendering charts...');
      renderSalesTrendChart();
      renderSalesLocationChart();
      renderPurchasesLocationChart();
      renderPaymentStatusChart();
      renderTopCustomersChart();
      console.log('âœ… All charts rendered');
    }
    
    // 1. Overall Sales Trend Chart
    function renderSalesTrendChart() {
      const ctx = document.getElementById('salesTrendChart');
      if (charts.salesTrend) charts.salesTrend.destroy();
      
      const monthlySales = {};
      dashboardData.sales.forEach(sale => {
        const date = parseDate(sale.date);
        const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
        if (!monthlySales[monthYear]) {
          monthlySales[monthYear] = { date: date, amount: 0 };
        }
        monthlySales[monthYear].amount += parseFloat(sale.total_amount) || 0;
      });
      
      const sortedMonths = Object.keys(monthlySales).sort((a, b) => monthlySales[a].date - monthlySales[b].date);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const labels = sortedMonths.map(key => {
        const date = monthlySales[key].date;
        return `${months[date.getMonth()]} ${date.getFullYear()}`;
      });
      const data = sortedMonths.map(key => monthlySales[key].amount);
      
      charts.salesTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sales',
            data: data,
            backgroundColor: 'rgba(2, 22, 64, 0.2)',
            borderColor: '#021640',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#021640',
            pointBorderColor: '#021640',
            pointRadius: 2,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => 'KSH ' + formatNumber(context.parsed.y)
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (value) => formatToThousands(value) }
            }
          }
        }
      });
    }
    
    // 2. Sales by Location
    function renderSalesLocationChart() {
      const ctx = document.getElementById('salesLocationChart');
      if (charts.salesLocation) charts.salesLocation.destroy();
      
      const locationSales = {};
      dashboardData.sales.forEach(sale => {
        const county = sale.county || 'Unknown';
        locationSales[county] = (locationSales[county] || 0) + (parseFloat(sale.total_amount) || 0);
      });
      
      charts.salesLocation = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(locationSales),
          datasets: [{
            label: 'Sales Amount',
            data: Object.values(locationSales),
            backgroundColor: 'rgba(26, 188, 156, 0.7)',
            borderColor: 'rgba(26, 188, 156, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (context) => 'KSH ' + formatNumber(context.parsed.y) } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => formatToThousands(value) } }
          }
        }
      });
    }
    
    // 3. Purchases by Location
    function renderPurchasesLocationChart() {
      const ctx = document.getElementById('purchasesLocationChart');
      if (charts.purchasesLocation) charts.purchasesLocation.destroy();
      
      const locationPurchases = {};
      dashboardData.purchases.forEach(purchase => {
        const county = purchase.county || 'Unknown';
        locationPurchases[county] = (locationPurchases[county] || 0) + (parseFloat(purchase.total_amount) || 0);
      });
      
      charts.purchasesLocation = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(locationPurchases),
          datasets: [{
            label: 'Purchase Amount',
            data: Object.values(locationPurchases),
            backgroundColor: 'rgba(52, 152, 219, 0.7)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (context) => 'KSH ' + formatNumber(context.parsed.y) } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => formatToThousands(value) } }
          }
        }
      });
    }
    
    // 4. Payment Status
    function renderPaymentStatusChart() {
      const ctx = document.getElementById('paymentStatusChart');
      if (charts.paymentStatus) charts.paymentStatus.destroy();
      
      const statusCounts = { completed: 0, pending: 0, partial: 0 };
      
      dashboardData.purchases.forEach(po => {
        const status = (po.payment_status || '').toLowerCase();
        if (status === 'completed') statusCounts.completed++;
        else if (status === 'pending') statusCounts.pending++;
        else if (status.includes('partial')) statusCounts.partial++;
      });
      
      dashboardData.sales.forEach(so => {
        const status = (so.receipt_status || '').toLowerCase();
        if (status === 'completed') statusCounts.completed++;
        else if (status === 'pending') statusCounts.pending++;
        else if (status.includes('partial')) statusCounts.partial++;
      });
      
      charts.paymentStatus = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Completed', 'Partial Payment', 'Pending'],
          datasets: [{
            data: [statusCounts.completed, statusCounts.partial, statusCounts.pending],
            backgroundColor: ['rgba(46, 204, 113, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(243, 156, 18, 0.8)'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
    
    // 5. Top Customers
    function renderTopCustomersChart() {
      const ctx = document.getElementById('topCustomersChart');
      if (charts.topCustomers) charts.topCustomers.destroy();
      
      const topCustomers = [...dashboardData.customers]
        .sort((a, b) => (parseFloat(b.sales) || 0) - (parseFloat(a.sales) || 0))
        .slice(0, 5);
      
      charts.topCustomers = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topCustomers.map(c => c.name || 'Unknown'),
          datasets: [{
            label: 'Total Sales',
            data: topCustomers.map(c => parseFloat(c.sales) || 0),
            backgroundColor: 'rgba(155, 89, 182, 0.7)',
            borderColor: 'rgba(155, 89, 182, 1)',
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (context) => 'KSH ' + formatNumber(context.parsed.x) } }
          },
scales: {
x: { beginAtZero: true, ticks: { callback: (value) => formatToThousands(value) } }
}
}
});
}

// 6. Sales by Category (from Details)
    function renderSalesCategoryChart() {
      const ctx = document.getElementById('salesCategoryChart');
      if (charts.salesCategory) charts.salesCategory.destroy();
      
      const categorySales = {};
      dashboardData.salesDetails.forEach(detail => {
        const category = detail.item_category || 'Unknown';
        categorySales[category] = (categorySales[category] || 0) + (parseFloat(detail.total_sales_price) || 0);
      });
      
      const sortedCategories = Object.entries(categorySales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      
      charts.salesCategory = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedCategories.map(c => c[0]),
          datasets: [{
            data: sortedCategories.map(c => c[1]),
            backgroundColor: [
              'rgba(26, 188, 156, 0.8)',
              'rgba(52, 152, 219, 0.8)',
              'rgba(155, 89, 182, 0.8)',
              'rgba(230, 126, 34, 0.8)',
              'rgba(231, 76, 60, 0.8)',
              'rgba(243, 156, 18, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: KSH ${formatNumber(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // 7. Purchases by Category (from Details)
    function renderPurchasesCategoryChart() {
      const ctx = document.getElementById('purchasesCategoryChart');
      if (charts.purchasesCategory) charts.purchasesCategory.destroy();
      
      const categoryPurchases = {};
      dashboardData.purchaseDetails.forEach(detail => {
        const category = detail.item_category || 'Unknown';
        categoryPurchases[category] = (categoryPurchases[category] || 0) + (parseFloat(detail.total_purchase_price) || 0);
      });
      
      const sortedCategories = Object.entries(categoryPurchases)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      
      charts.purchasesCategory = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedCategories.map(c => c[0]),
          datasets: [{
            data: sortedCategories.map(c => c[1]),
            backgroundColor: [
              'rgba(52, 152, 219, 0.8)',
              'rgba(26, 188, 156, 0.8)',
              'rgba(230, 126, 34, 0.8)',
              'rgba(155, 89, 182, 0.8)',
              'rgba(243, 156, 18, 0.8)',
              'rgba(231, 76, 60, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: KSH ${formatNumber(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Update KPIs - Additional Calculations
    function updateAdditionalKPIs() {
      // Top Selling Item
      const itemSales = {};
      dashboardData.salesDetails.forEach(detail => {
        const itemName = detail.item_name;
        if (!itemSales[itemName]) {
          itemSales[itemName] = {
            qty: 0,
            revenue: 0,
            category: detail.item_category,
            type: detail.item_type
          };
        }
        itemSales[itemName].qty += parseInt(detail.quantity_sold) || 0;
        itemSales[itemName].revenue += parseFloat(detail.total_sales_price) || 0;
      });
      
      const topItem = Object.entries(itemSales)
        .sort((a, b) => b[1].qty - a[1].qty)[0];
      
      if (topItem) {
        const [itemName, data] = topItem;
        document.getElementById('topSellingItem').textContent = itemName;
        document.getElementById('topItemCategory').textContent = `${data.category} | ${data.type}`;
      } else {
        document.getElementById('topSellingItem').textContent = 'No Data';
        document.getElementById('topItemCategory').textContent = 'N/A';
      }
      
      // Top Sales Location
      const locationSales = {};
      dashboardData.sales.forEach(sale => {
        const county = sale.county || 'Unknown';
        locationSales[county] = (locationSales[county] || 0) + (parseFloat(sale.total_amount) || 0);
      });
      
      const topLocation = Object.entries(locationSales)
        .sort((a, b) => b[1] - a[1])[0];
      
      if (topLocation) {
        const [county, amount] = topLocation;
        document.getElementById('topSalesLocation').textContent = county;
        document.getElementById('topLocationAmount').textContent = `KSH ${formatNumber(amount)}`;
      } else {
        document.getElementById('topSalesLocation').textContent = 'No Data';
        document.getElementById('topLocationAmount').textContent = 'N/A';
      }
    }
    
    // Render Tables
    function renderTables() {
      renderLowStockTable();
      renderRecentSalesTable();
      renderRecentPurchasesTable();
      updateAdditionalKPIs();
      renderSalesCategoryChart();
      renderPurchasesCategoryChart();
    }
    
    // 1. Low Stock Table
    function renderLowStockTable() {
      const tableBody = document.getElementById('lowStockTable');
      const lowStockItems = dashboardData.inventory
        .filter(item => item.reorderRequired === 'YES')
        .sort((a, b) => (a.remainingQty - a.reorderLevel) - (b.remainingQty - b.reorderLevel))
        .slice(0, 10);
      
      if (lowStockItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #2ecc71;"><i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>All items are adequately stocked!</td></tr>';
        return;
      }
      
      tableBody.innerHTML = lowStockItems.map(item => `
        <tr>
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td style="font-weight: 600; color: ${item.remainingQty === 0 ? '#e74c3c' : '#f39c12'};">${item.remainingQty}</td>
          <td>${item.reorderLevel}</td>
          <td>
            <span class="status-badge reorder">
              <i class="fas fa-exclamation-triangle"></i> REORDER
            </span>
          </td>
        </tr>
      `).join('');
    }
    
    // 2. Recent Sales Table
    function renderRecentSalesTable() {
      const tableBody = document.getElementById('recentSalesTable');
      const recentSales = [...dashboardData.sales]
        .sort((a, b) => parseDate(b.date) - parseDate(a.date))
        .slice(0, 10);
      
      if (recentSales.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No sales orders yet</td></tr>';
        return;
      }
      
      tableBody.innerHTML = recentSales.map(sale => {
        const receiptStatusClass = (sale.receipt_status || '').toLowerCase().replace(/\s+/g, '-');
        const shippingStatusClass = (sale.shipping_status || '').toLowerCase().replace(/\s+/g, '-');
        
        return `
          <tr>
            <td>${sale.so_id}</td>
            <td>${sale.date}</td>
            <td>${sale.customer_name}</td>
            <td>KSH ${formatNumber(parseFloat(sale.total_amount) || 0)}</td>
            <td>
              <span class="status-badge ${receiptStatusClass}">
                ${sale.receipt_status || 'N/A'}
              </span>
            </td>
            <td>
              <span class="status-badge ${shippingStatusClass}">
                ${sale.shipping_status || 'N/A'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // 3. Recent Purchases Table
    function renderRecentPurchasesTable() {
      const tableBody = document.getElementById('recentPurchasesTable');
      const recentPurchases = [...dashboardData.purchases]
        .sort((a, b) => parseDate(b.date) - parseDate(a.date))
        .slice(0, 10);
      
      if (recentPurchases.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">No purchase orders yet</td></tr>';
        return;
      }
      
      tableBody.innerHTML = recentPurchases.map(purchase => {
        const paymentStatusClass = (purchase.payment_status || '').toLowerCase().replace(/\s+/g, '-');
        const shippingStatusClass = (purchase.shipping_status || '').toLowerCase().replace(/\s+/g, '-');
        
        return `
          <tr>
            <td>${purchase.po_id}</td>
            <td>${purchase.date}</td>
            <td>${purchase.supplier_name}</td>
            <td>KSH ${formatNumber(parseFloat(purchase.total_amount) || 0)}</td>
            <td>
              <span class="status-badge ${paymentStatusClass}">
                ${purchase.payment_status || 'N/A'}
              </span>
            </td>
            <td>
              <span class="status-badge ${shippingStatusClass}">
                ${purchase.shipping_status || 'N/A'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }
    console.log('âœ… Dashboard JavaScript Complete!');

  </script>
</body>
</html>
      