{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% block title %}PURCHASE ORDERS{% endblock %}</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
  
  <!-- Flatpickr (Date Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root {
      --primary: #1abc9c;
      --primary-light: #d1f2eb;
      --primary-dark: #16a085;
      --secondary: #3498db;
      --dark: #2c3e50;
      --light-dark: #34495e;
      --gray: #7f8c8d;
      --light-gray: #ecf0f1;
      --white: #ffffff;
      --error: #e74c3c;
      --warning: #f39c12;
      --success: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: var(--light-dark);
    }
    
    .purchase-container {
      max-width: 1600px;
      margin: 0 auto;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      padding: 25px;
    }
    
    .header-section {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .header-section h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .btn-secondary:hover {
      background-color: #2980b9;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid #bdc3c7;
      color: var(--light-dark);
    }
    
    .btn-outline:hover {
      background-color: var(--light-gray);
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .search-select {
      padding: 9px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      background-color: var(--white);
      min-width: 160px;
    }
    
    .search-input {
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      width: 250px;
    }
    
    .purchase-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--white);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .purchase-table th {
      background-color: var(--dark);
      color: var(--white);
      padding: 14px 16px;
      text-align: left;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    .purchase-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--light-gray);
      color: var(--light-dark);
      font-size: 0.92rem;
    }
    
    .purchase-table tr:hover {
      background-color: rgba(26, 188, 156, 0.05);
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      color: white;
    }
    
    .view-btn {
      background-color: #3498db;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 0;
      padding: 30px;
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-header h2 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 1.6rem;
      margin: 0;
    }
    
    .close-btn {
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: color 0.3s;
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background-color: #fafafa;
    }
    
    .form-section h3 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }

    .no-data-container {
      display: none;
      text-align: center;
      padding: 50px 20px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 20px;
    }

    .items-table {
      width: max-content;
      table-layout: auto;
      border-collapse: collapse;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-control {
      width: 100%;
      padding: 11px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95rem;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
    }
    
    .required:after {
      content: " *";
      color: var(--error);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }
    
    .processing-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .select2-container {
      width: 100% !important;
    }
    
    .id-generate {
      display: flex;
      gap: 10px;
    }
    
    .id-field {
      flex: 1;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 25px;
      gap: 6px;
    }
    
    .page-btn {
      padding: 8px 14px;
      background-color: var(--white);
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Roboto', sans-serif;
      transition: all 0.3s;
    }
    
    .page-btn:hover:not(.active) {
      background-color: var(--light-gray);
    }
    
    .page-btn.active {
      background-color: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }
    
    .no-data-icon {
      font-size: 3.5rem;
      color: #bdc3c7;
      margin-bottom: 20px;
    }
    
    .no-data-title {
      color: var(--gray);
      margin-bottom: 10px;
      font-family: 'Montserrat', sans-serif;
    }
    
    .items-table th, .items-table td {
      padding: 8px 12px;
      white-space: nowrap;
    }

    .items-table input, .items-table select {
      width: 100%;
      min-width: 100px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table input:focus, .items-table select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .items-table .readonly {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table-container {
      max-height: auto;
      overflow-x: auto;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-top: 15px;
      margin-bottom: 20px;
    }
    
    .add-item-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 10px;
    }
    
    .remove-item-btn {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>
  <div class="purchase-container">
    <!-- Header Section -->
    <div class="header-section">
      <h1>CREATE AND MANAGE YOUR PURCHASE ORDERS AND THEIR DETAILS</h1>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="poOpenNewPOModal()">
          <i class="fas fa-file-invoice"></i> New Purchase Order
        </button>
        <button class="btn btn-secondary" onclick="poOpenPMTStatusModal()">
          <i class="fas fa-money-bill-wave"></i> New Payment Status
        </button>
        <button class="btn btn-secondary" onclick="poOpenShippingStatusModal()">
          <i class="fas fa-truck"></i> New Shipping Status
        </button>
      </div>
      
      <div class="search-group">
        <select id="poSearchCriteria" class="search-select" title="poSearchCriteria">
          <option value="all">All</option>
          <option value="PO ID">PO ID</option>
          <option value="Supplier Name">Supplier Name</option>
          <option value="Bill Num">Bill Number</option>
          <option value="Payment Status">Payment Status</option>
          <option value="Shipping Status">Shipping Status</option>
        </select>
        <input type="text" id="poSearchInput" class="search-input" placeholder="Search...">
        <button class="btn btn-outline" onclick="poSearchPOs()">
          <i class="fas fa-search"></i> Search
        </button>
        <button class="btn btn-outline" onclick="poClearSearch()">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>
    
    <!-- Purchase Orders Table -->
    <div id="poTableContainer">
      <table class="purchase-table">
        <thead>
          <tr>
            <th>PO ID</th>
            <th>Date</th>
            <th>Supplier ID</th>
            <th>Supplier Name</th>
            <th>Bill Number</th>
            <th>County</th>
            <th>Town</th>
            <th>Total Amount</th>
            <th>Amount Paid</th>
            <th>PO Balance</th>
            <th>Payment Status</th>
            <th>Shipping Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="poTableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="pagination" id="poPagination">
        <!-- Pagination buttons will be added here -->
      </div>
    </div>
    
    <!-- No Data Message -->
    <div id="poNoData" class="no-data-container">
      <i class="fas fa-inbox no-data-icon"></i>
      <h3 class="no-data-title">No purchase orders found</h3>
      <p>Click "New Purchase Order" to create a purchase order</p>
    </div>
  </div>
  
  <!-- Payment Status Modal -->
  <div id="poPMTStatusModal" class="modal">
    <div class="modal-content" style="width: 450px; height: auto; margin: 5% auto;">
      <div class="modal-header">
        <h2>Configure Payment Status</h2>
        <span class="close-btn" onclick="poClosePMTStatusModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Payment Status</label>
        <input type="text" id="poNewPMTStatus" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="poClosePMTStatusModal()">Close</button>
        <button class="btn btn-primary" onclick="poSaveNewPMTStatus()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Shipping Status Modal -->
  <div id="poShippingStatusModal" class="modal">
    <div class="modal-content" style="width: 450px; height: auto; margin: 5% auto;">
      <div class="modal-header">
        <h2>Configure Shipping Status</h2>
        <span class="close-btn" onclick="poCloseShippingStatusModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Shipping Status</label>
        <input type="text" id="poNewShippingStatus" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="poCloseShippingStatusModal()">Close</button>
        <button class="btn btn-primary" onclick="poSaveNewShippingStatus()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- New/Edit PO Modal -->
  <div id="poNewPOModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="poModalTitle">Create New Purchase Order</h2>
        <span class="close-btn" onclick="poCloseNewPOModal()">&times;</span>
      </div>
      
      <!-- Section 1: PO Header -->
      <div class="form-section">
        <h3>PO Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="required">PO ID</label>
            <div class="id-generate">
              <input type="text" id="poPOID" class="form-control id-field" readonly>
              <button class="btn btn-secondary" onclick="poGeneratePOID()" id="poGenerateBtn">Generate</button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="required">PO Date</label>
            <input type="text" id="poPODate" class="form-control date-picker" placeholder="DD/MM/YYYY">
          </div>
          
          <div class="form-group">
            <label class="required">Supplier Name</label>
            <select id="poSupplierName" class="form-control"></select>
          </div>
          
          <div class="form-group">
            <label class="required">Supplier ID</label>
            <input type="text" id="poSupplierID" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">County</label>
            <input type="text" id="poCounty" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">Town</label>
            <input type="text" id="poTown" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">Bill Number</label>
            <input type="text" id="poBillNum" class="form-control" readonly>
          </div>
        </div>
      </div>
      
      <!-- Section 2: PO Items -->
      <div class="form-section">
        <h3>PO Items</h3>
        <button class="add-item-btn" onclick="poAddItemRow()">
          <i class="fas fa-plus"></i> Add Item
        </button>
        
        <div class="items-table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>PO ID</th>
                <th>Detail ID</th>
                <th>Supplier ID</th>
                <th>Supplier Name</th>
                <th>County</th>
                <th>Town</th>
                <th>Bill Number</th>
                <th>Item ID</th>
                <th>Item Type</th>
                <th>Item Category</th>
                <th>Item Subcategory</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Unit Cost</th>
                <th>Cost Excluding Tax</th>
                <th>Tax Rate (%)</th>
                <th>Total Tax</th>
                <th>Cost Inclusive of Tax</th>
                <th>Shipping Fees</th>
                <th>Total Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="poItemsTableBody">
              <!-- Item rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="poCloseNewPOModal()">Close</button>
        <button class="btn btn-primary" onclick="poSaveNewPO()" id="poSaveBtn">Save PO</button>
      </div>
    </div>
  </div>
  
  <!-- Processing Overlay -->
  <div id="poProcessingOverlay" class="processing-overlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    console.log('Purchases.js loaded');

    // Global variables
    let poCurrentPage = 1;
    const poPageSize = 25;
    let poAllPOs = [];
    let poFilteredPOs = [];
    let poSuppliers = [];
    let poInventoryItems = [];
    let poPMTStatuses = [];
    let poShippingStatuses = [];
    let poIsEditMode = false;
    let poCurrentPOID = null;
    let poDetailCounter = 1;
    let poNextDetailNumber = null;          // Global variable to track the detail counter

    // CSRF Token
    function getCSRFToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
      }
      return null;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing purchases...');
      loadSuppliers();
      loadInventoryItems();
      loadPMTStatuses();
      loadShippingStatuses();
      loadPurchaseOrders();
      initializeDatePicker();
    });

    // Initialize Flatpickr date picker
    function initializeDatePicker() {
      flatpickr("#poPODate", {
        dateFormat: "d/m/Y",
        allowInput: true
      });
    }

    // Load suppliers
    async function loadSuppliers() {
      try {
        const response = await fetch('/api/suppliers/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poSuppliers = result.data;
          populateSupplierDropdown();
        }
      } catch (error) {
        console.error('Error loading suppliers:', error);
      }
    }

    // Populate supplier dropdown
    function populateSupplierDropdown() {
      const supplierSelect = $('#poSupplierName');
      supplierSelect.empty();
      supplierSelect.append(new Option('Select Supplier', '', true, true));
      
      poSuppliers.forEach(supplier => {
        if (supplier) {
          supplierSelect.append(new Option(supplier.name, supplier.name));
        }
      });
      
      supplierSelect.select2({
        placeholder: 'Select Supplier',
        allowClear: true,
        dropdownParent: $('#poNewPOModal')
      });

      supplierSelect.on('change', function() {
        poSupplierChanged();
      });
    }

    // Supplier changed event
    function poSupplierChanged() {
      const supplierName = $('#poSupplierName').val();
      const supplier = poSuppliers.find(s => s.name === supplierName);
      
      if (supplier) {
        $('#poSupplierID').val(supplier.id);
        $('#poCounty').val(supplier.state);
        $('#poTown').val(supplier.city);
        
        // Update all item rows
        updateAllItemRowsWithHeaderData();
      } else {
        $('#poSupplierID').val('');
        $('#poCounty').val('');
        $('#poTown').val('');
      }
    }

    // Load inventory items
    async function loadInventoryItems() {
      try {
        const response = await fetch('/api/inventory-items/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poInventoryItems = result.data;
        }
      } catch (error) {
        console.error('Error loading inventory items:', error);
      }
    }

    // Load payment statuses
    async function loadPMTStatuses() {
      try {
        const response = await fetch('/api/purchases/payment-statuses/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poPMTStatuses = result.data;
        }
      } catch (error) {
        console.error('Error loading payment statuses:', error);
      }
    }

    // Load shipping statuses
    async function loadShippingStatuses() {
      try {
        const response = await fetch('/api/purchases/shipping-statuses/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poShippingStatuses = result.data;
        }
      } catch (error) {
        console.error('Error loading shipping statuses:', error);
      }
    }

    // Load purchase orders
    async function loadPurchaseOrders() {
      showProcessing();
      try {
        const response = await fetch('/api/purchases/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poAllPOs = result.data;
          poFilteredPOs = [...result.data];
          renderPOTable();
        } else {
          alert('Error loading purchase orders: ' + result.message);
        }
      } catch (error) {
        console.error('Error loading purchase orders:', error);
        alert('Failed to load purchase orders');
      } finally {
        hideProcessing();
      }
    }

    // Render PO table
    function renderPOTable() {
      const startIndex = (poCurrentPage - 1) * poPageSize;
      const endIndex = startIndex + poPageSize;
      const pagePOs = poFilteredPOs.slice(startIndex, endIndex);
      const tableBody = document.getElementById('poTableBody');
      
      tableBody.innerHTML = '';
      
      if (pagePOs.length === 0) {
        document.getElementById('poTableContainer').style.display = 'none';
        document.getElementById('poNoData').style.display = 'block';
        document.getElementById('poPagination').innerHTML = '';
        return;
      }
      
      document.getElementById('poTableContainer').style.display = 'block';
      document.getElementById('poNoData').style.display = 'none';
      
      pagePOs.forEach((po) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${po.po_id}</td>
          <td>${po.date}</td>
          <td>${po.supplier_id}</td>
          <td>${po.supplier_name}</td>
          <td>${po.bill_number}</td>
          <td>${po.county || ''}</td>
          <td>${po.town || ''}</td>
          <td>${parseFloat(po.total_amount).toFixed(2)}</td>
          <td>${parseFloat(po.amount_paid).toFixed(2)}</td>
          <td>${parseFloat(po.balance_left).toFixed(2)}</td>
          <td>${po.payment_status || ''}</td>
          <td>${po.shipping_status || ''}</td>
          <td class="action-cell">
            <button class="action-btn view-btn" onclick="poViewPO('${po.po_id}')">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      renderPOPagination();
    }

    // Render pagination
    function renderPOPagination() {
      const totalPages = Math.ceil(poFilteredPOs.length / poPageSize);
      const paginationDiv = document.getElementById('poPagination');
      paginationDiv.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = poCurrentPage === 1;
      prevBtn.onclick = () => {
        if (poCurrentPage > 1) {
          poCurrentPage--;
          renderPOTable();
        }
      };
      paginationDiv.appendChild(prevBtn);
      
      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === poCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
          poCurrentPage = i;
          renderPOTable();
        };
        paginationDiv.appendChild(pageBtn);
      }
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = poCurrentPage === totalPages;
      nextBtn.onclick = () => {
        if (poCurrentPage < totalPages) {
          poCurrentPage++;
          renderPOTable();
        }
      };
      paginationDiv.appendChild(nextBtn);
    }

    // Open new PO modal
    function poOpenNewPOModal() {
      poIsEditMode = false;
      poCurrentPOID = null;
      document.getElementById('poModalTitle').textContent = 'Create New Purchase Order';
      document.getElementById('poSaveBtn').textContent = 'Save PO';
      document.getElementById('poGenerateBtn').style.display = 'inline-block';
      
      // Clear form
      document.getElementById('poPOID').value = '';
      document.getElementById('poPODate').value = '';
      $('#poSupplierName').val('').trigger('change');
      document.getElementById('poSupplierID').value = '';
      document.getElementById('poCounty').value = '';
      document.getElementById('poTown').value = '';
      document.getElementById('poBillNum').value = '';
      document.getElementById('poItemsTableBody').innerHTML = '';
      
      poDetailCounter = 1;
      document.getElementById('poNewPOModal').style.display = 'block';
    }

    // Close PO modal
    function poCloseNewPOModal() {
      document.getElementById('poNewPOModal').style.display = 'none';
    }

    // Generate PO ID
    async function poGeneratePOID() {
      showProcessing();
      try {
        const response = await fetch('/api/purchases/generate-po-id/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('poPOID').value = result.po_id;
          document.getElementById('poBillNum').value = result.bill_number;
          
          // Update all item rows
          updateAllItemRowsWithHeaderData();
        } else {
          alert('Error generating PO ID: ' + result.message);
        }
      } catch (error) {
        console.error('Error generating PO ID:', error);
        alert('Failed to generate PO ID');
      } finally {
        hideProcessing();
      }
    }

    // Load the next available detail number on page load
async function loadNextDetailNumber() {
  try {
    const response = await fetch('/api/purchases/get-next-detail-number/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    if (result.success) {
      poNextDetailNumber = result.next_number;
    }
  } catch (error) {
    console.error('Error loading next detail number:', error);
    poNextDetailNumber = 1;
  }
}

// Update DOMContentLoaded to load the next detail number
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing purchases...');
  loadSuppliers();
  loadInventoryItems();
  loadPMTStatuses();
  loadShippingStatuses();
  loadPurchaseOrders();
  loadNextDetailNumber(); // â† Add this line
  initializeDatePicker();
});

// FOR PURCHASES MODULE - Replace the entire poAddItemRow function
async function poAddItemRow() {
  const poID = document.getElementById('poPOID').value;
  const poDate = document.getElementById('poPODate').value;
  const supplierID = document.getElementById('poSupplierID').value;
  const supplierName = $('#poSupplierName').val();
  const county = document.getElementById('poCounty').value;
  const town = document.getElementById('poTown').value;
  const billNum = document.getElementById('poBillNum').value;
  
  if (!poID || !poDate || !supplierName) {
    alert('Please fill PO ID, Date, and Supplier Name first');
    return;
  }
  
  // âœ… CRITICAL FIX: Generate FRESH Detail ID on EACH call
  showProcessing();
  
  try {
    // Force fresh API call with cache-busting timestamp
    const timestamp = new Date().getTime();
    const response = await fetch(`/api/purchases/generate-detail-id/?t=${timestamp}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      },
      credentials: 'same-origin',
      cache: 'no-store'  // Prevent caching
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert('Error generating Detail ID: ' + result.message);
      hideProcessing();
      return;
    }
    
    const detailID = result.detail_id;
    
    // âœ… VERIFICATION: Log the Detail ID to console
    console.log(`ðŸ†• Generated NEW Detail ID: ${detailID} at ${new Date().toLocaleTimeString()}`);
    
    const tbody = document.getElementById('poItemsTableBody');
    const row = document.createElement('tr');
    row.setAttribute('data-detail-id', detailID);
    
    // Create item name dropdown options
    let itemOptions = '<option value="">Select Item</option>';
    poInventoryItems.forEach(item => {
      itemOptions += `<option value="${item.name}" data-item-id="${item.id}" data-type="${item.type}" data-category="${item.category}" data-subcategory="${item.subcategory}" data-purchase-price="${item.purchase_price}">${item.name}</option>`;
    });
    
    row.innerHTML = `
      <td><input type="text" class="readonly" value="${poDate}" readonly></td>
      <td><input type="text" class="readonly" value="${poID}" readonly></td>
      <td><input type="text" class="readonly" value="${detailID}" readonly></td>
      <td><input type="text" class="readonly" value="${supplierID}" readonly></td>
      <td><input type="text" class="readonly" value="${supplierName}" readonly></td>
      <td><input type="text" class="readonly" value="${county}" readonly></td>
      <td><input type="text" class="readonly" value="${town}" readonly></td>
      <td><input type="text" class="readonly" value="${billNum}" readonly></td>
      <td><input type="text" class="readonly item-id" value="" readonly></td>
      <td><input type="text" class="readonly item-type" value="" readonly></td>
      <td><input type="text" class="readonly item-category" value="" readonly></td>
      <td><input type="text" class="readonly item-subcategory" value="" readonly></td>
      <td><select class="item-name-select" style="min-width: 200px;">${itemOptions}</select></td>
      <td><input type="number" class="qty-input" min="1" value="1"></td>
      <td><input type="text" class="readonly unit-cost" value="0.00" readonly></td>
      <td><input type="text" class="readonly cost-excl-tax" value="0.00" readonly></td>
      <td><input type="number" class="tax-rate-input" step="0.01" min="0" value="0"></td>
      <td><input type="text" class="readonly total-tax" value="0.00" readonly></td>
      <td><input type="text" class="readonly cost-incl-tax" value="0.00" readonly></td>
      <td><input type="text" class="readonly shipping-fees" value="0.00" readonly></td>
      <td><input type="text" class="readonly total-price" value="0.00" readonly></td>
      <td>
        <button class="remove-item-btn" onclick="poRemoveItemRow(this)">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
    
    // Initialize Select2 for item name
    $(row).find('.item-name-select').select2({
      placeholder: 'Select Item',
      allowClear: true,
      dropdownParent: $('#poNewPOModal')
    }).on('change', function() {
      poItemChanged(this);
    });

    // Add event listeners for calculations
    $(row).find('.qty-input, .tax-rate-input').on('input', function() {
      poCalculateRowTotals(row);
    });
    
    poDetailCounter++;
    hideProcessing();
    
  } catch (error) {
    console.error('Error generating Detail ID:', error);
    alert('Failed to generate Detail ID: ' + error.message);
    hideProcessing();
  }
}

// ============================================================
// VERIFICATION HELPER - Add this function to test
// ============================================================
async function testDetailIDGeneration() {
  console.log("\nðŸ§ª TESTING DETAIL ID GENERATION\n");
  
  for (let i = 1; i <= 5; i++) {
    const timestamp = new Date().getTime();
    
    try {
      // Test Sales
      const salesResponse = await fetch(`/api/sales/generate-detail-id/?t=${timestamp}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin',
        cache: 'no-store'
      });
      
      const salesResult = await salesResponse.json();
      console.log(`Test ${i} - Sales Detail ID: ${salesResult.detail_id}`);
      
      // Test Purchases
      const purchasesResponse = await fetch(`/api/purchases/generate-detail-id/?t=${timestamp + 1}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin',
        cache: 'no-store'
      });
      
      const purchasesResult = await purchasesResponse.json();
      console.log(`Test ${i} - Purchases Detail ID: ${purchasesResult.detail_id}\n`);
      
    } catch (error) {
      console.error(`Test ${i} failed:`, error);
    }
  }
  
  console.log("âœ… Test Complete\n");
}

// To run the test, open browser console and type: testDetailIDGeneration()


// Update poOpenNewPOModal to reset counter when opening new PO
function poOpenNewPOModal() {
  poIsEditMode = false;
  poCurrentPOID = null;
  document.getElementById('poModalTitle').textContent = 'Create New Purchase Order';
  document.getElementById('poSaveBtn').textContent = 'Save PO';
  document.getElementById('poGenerateBtn').style.display = 'inline-block';
  
  // Clear form
  document.getElementById('poPOID').value = '';
  document.getElementById('poPODate').value = '';
  $('#poSupplierName').val('').trigger('change');
  document.getElementById('poSupplierID').value = '';
  document.getElementById('poCounty').value = '';
  document.getElementById('poTown').value = '';
  document.getElementById('poBillNum').value = '';
  document.getElementById('poItemsTableBody').innerHTML = '';
  
  // Reset detail counter for new PO
  loadNextDetailNumber(); // â† Reload to get latest number
  
  document.getElementById('poNewPOModal').style.display = 'block';
}

    // Item changed event
    function poItemChanged(selectElement) {
      const row = selectElement.closest('tr');
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      
      if (selectedOption.value) {
        const itemID = selectedOption.getAttribute('data-item-id');
        const itemType = selectedOption.getAttribute('data-type');
        const itemCategory = selectedOption.getAttribute('data-category');
        const itemSubcategory = selectedOption.getAttribute('data-subcategory');
        const purchasePrice = parseFloat(selectedOption.getAttribute('data-purchase-price')) || 0;
        
        $(row).find('.item-id').val(itemID);
        $(row).find('.item-type').val(itemType);
        $(row).find('.item-category').val(itemCategory);
        $(row).find('.item-subcategory').val(itemSubcategory);
        $(row).find('.unit-cost').val(purchasePrice.toFixed(2));
        
        poCalculateRowTotals(row);
      } else {
        $(row).find('.item-id').val('');
        $(row).find('.item-type').val('');
        $(row).find('.item-category').val('');
        $(row).find('.item-subcategory').val('');
        $(row).find('.unit-cost').val('0.00');
        poCalculateRowTotals(row);
      }
    }

    // Calculate row totals
    function poCalculateRowTotals(row) {
      const qty = parseFloat($(row).find('.qty-input').val()) || 0;
      const unitCost = parseFloat($(row).find('.unit-cost').val()) || 0;
      const taxRate = parseFloat($(row).find('.tax-rate-input').val()) || 0;
      
      // Cost Excl Tax = QTY * Unit Cost
      const costExclTax = qty * unitCost;
      
      // Total Tax = Cost Excl Tax * (Tax Rate / 100)
      const totalTax = costExclTax * (taxRate / 100);
      
      // Cost Incl Tax = Cost Excl Tax + Total Tax
      const costInclTax = costExclTax + totalTax;
      
      // Shipping Fees = Cost Incl Tax * 1%
      const shippingFees = costInclTax * 0.01;
      
      // Total Price = Cost Incl Tax + Shipping Fees
      const totalPrice = costInclTax + shippingFees;
      
      $(row).find('.cost-excl-tax').val(costExclTax.toFixed(2));
      $(row).find('.total-tax').val(totalTax.toFixed(2));
      $(row).find('.cost-incl-tax').val(costInclTax.toFixed(2));
      $(row).find('.shipping-fees').val(shippingFees.toFixed(2));
      $(row).find('.total-price').val(totalPrice.toFixed(2));
    }

    // Remove item row
    function poRemoveItemRow(button) {
      if (confirm('Are you sure you want to remove this item?')) {
        button.closest('tr').remove();
      }
    }

    // Update all item rows with header data
    function updateAllItemRowsWithHeaderData() {
      const poID = document.getElementById('poPOID').value;
      const poDate = document.getElementById('poPODate').value;
      const supplierID = document.getElementById('poSupplierID').value;
      const supplierName = $('#poSupplierName').val();
      const county = document.getElementById('poCounty').value;
      const town = document.getElementById('poTown').value;
      const billNum = document.getElementById('poBillNum').value;
      
      $('#poItemsTableBody tr').each(function() {
        $(this).find('input').eq(0).val(poDate); // Date
        $(this).find('input').eq(1).val(poID); // PO ID
        $(this).find('input').eq(3).val(supplierID); // Supplier ID
        $(this).find('input').eq(4).val(supplierName); // Supplier Name
        $(this).find('input').eq(5).val(county); // County
        $(this).find('input').eq(6).val(town); // Town
        $(this).find('input').eq(7).val(billNum); // Bill Num
      });
    }

    // Watch for changes in header fields
    $('#poPODate, #poPOID, #poBillNum').on('change', function() {
      updateAllItemRowsWithHeaderData();
    });

    // Save new PO
    async function poSaveNewPO() {
      // Validate header
      const poID = document.getElementById('poPOID').value.trim();
      const poDate = document.getElementById('poPODate').value.trim();
      const supplierName = $('#poSupplierName').val();
      const supplierID = document.getElementById('poSupplierID').value.trim();
      const county = document.getElementById('poCounty').value.trim();
      const town = document.getElementById('poTown').value.trim();
      const billNum = document.getElementById('poBillNum').value.trim();
      
      if (!poID || !poDate || !supplierName || !billNum) {
        alert('Please fill all required fields in PO Information');
        return;
      }
      
      // Collect items
      const items = [];
      let hasError = false;
      
      $('#poItemsTableBody tr').each(function() {
        const detailID = $(this).attr('data-detail-id');
        const itemName = $(this).find('.item-name-select').val();
        const itemID = $(this).find('.item-id').val();
        const itemType = $(this).find('.item-type').val();
        const itemCategory = $(this).find('.item-category').val();
        const itemSubcategory = $(this).find('.item-subcategory').val();
        const qty = parseInt($(this).find('.qty-input').val()) || 0;
        const unitCost = parseFloat($(this).find('.unit-cost').val()) || 0;
        const taxRate = parseFloat($(this).find('.tax-rate-input').val()) || 0;
        const costExclTax = parseFloat($(this).find('.cost-excl-tax').val()) || 0;
        const totalTax = parseFloat($(this).find('.total-tax').val()) || 0;
        const costInclTax = parseFloat($(this).find('.cost-incl-tax').val()) || 0;
        const shippingFees = parseFloat($(this).find('.shipping-fees').val()) || 0;
        const totalPrice = parseFloat($(this).find('.total-price').val()) || 0;
        
        if (!itemName || qty <= 0) {
          alert('Please fill all item details correctly');
          hasError = true;
          return false;
        }
        
        items.push({
          detail_id: detailID,
          date: poDate,
          po_id: poID,
          supplier_id: supplierID,
          supplier_name: supplierName,
          county: county,
          town: town,
          bill_number: billNum,
          item_id: itemID,
          item_type: itemType,
          item_category: itemCategory,
          item_subcategory: itemSubcategory,
          item_name: itemName,
          quantity_purchased: qty,
          unit_cost: unitCost,
          tax_rate: taxRate,
          cost_excluding_tax: costExclTax,
          total_tax: totalTax,
          cost_including_tax: costInclTax,
          shipping_fees: shippingFees,
          total_purchase_price: totalPrice
        });
      });
      
      if (hasError || items.length === 0) {
        if (items.length === 0) alert('Please add at least one item');
        return;
      }
      
      const poData = {
        po_id: poID,
        date: poDate,
        supplier_id: supplierID,
        supplier_name: supplierName,
        county: county,
        town: town,
        bill_number: billNum,
        items: items
      };
      
      showProcessing();
      try {
        const url = poIsEditMode ? '/api/purchases/update/' : '/api/purchases/add/';
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify(poData)
        });
        
        const result = await response.json();
        if (result.success) {
          alert(poIsEditMode ? 'Purchase Order Updated Successfully' : 'Purchase Order Saved Successfully');
          poCloseNewPOModal();
          await loadPurchaseOrders();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving PO:', error);
        alert('Failed to save purchase order');
      } finally {
        hideProcessing();
      }
    }

    // View PO (Edit mode)
    async function poViewPO(poID) {
      showProcessing();
      try {
        const response = await fetch(`/api/purchases/details/${poID}/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          poIsEditMode = true;
          poCurrentPOID = poID;
          
          document.getElementById('poModalTitle').textContent = 'Update Purchase Order';
          document.getElementById('poSaveBtn').textContent = 'Update PO';
          document.getElementById('poGenerateBtn').style.display = 'none';
          
          // Populate header
          const po = result.data.purchase_order;
          document.getElementById('poPOID').value = po.po_id;
          document.getElementById('poPODate').value = po.date;
          $('#poSupplierName').val(po.supplier_name).trigger('change');
          document.getElementById('poSupplierID').value = po.supplier_id;
          document.getElementById('poCounty').value = po.county || '';
          document.getElementById('poTown').value = po.town || '';
          document.getElementById('poBillNum').value = po.bill_number;
          
          // Populate items
          document.getElementById('poItemsTableBody').innerHTML = '';
          const details = result.data.purchase_details;
          
          for (const detail of details) {
            await poAddExistingItemRow(detail);
          }
          
          document.getElementById('poNewPOModal').style.display = 'block';
        } else {
          alert('Error loading PO details: ' + result.message);
        }
      } catch (error) {
        console.error('Error loading PO:', error);
        alert('Failed to load purchase order');
      } finally {
        hideProcessing();
      }
    }

    // Add existing item row (for edit mode)
    async function poAddExistingItemRow(detail) {
      const tbody = document.getElementById('poItemsTableBody');
      const row = document.createElement('tr');
      row.setAttribute('data-detail-id', detail.detail_id);
      row.setAttribute('data-original-qty', detail.quantity_purchased);
      
      let itemOptions = '<option value="">Select Item</option>';
      poInventoryItems.forEach(item => {
        const selected = item.name === detail.item_name ? 'selected' : '';
        itemOptions += `<option value="${item.name}" data-item-id="${item.id}" data-type="${item.type}" data-category="${item.category}" data-subcategory="${item.subcategory}" data-purchase-price="${item.purchase_price}" ${selected}>${item.name}</option>`;
      });
      
      row.innerHTML = `
        <td><input type="text" class="readonly" value="${detail.date}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.po_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.detail_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.supplier_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.supplier_name}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.county || ''}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.town || ''}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.bill_number}" readonly></td>
        <td><input type="text" class="readonly item-id" value="${detail.item_id}" readonly></td>
        <td><input type="text" class="readonly item-type" value="${detail.item_type}" readonly></td>
        <td><input type="text" class="readonly item-category" value="${detail.item_category}" readonly></td>
        <td><input type="text" class="readonly item-subcategory" value="${detail.item_subcategory}" readonly></td>
        <td><select class="item-name-select" style="min-width: 200px;">${itemOptions}</select></td>
        <td><input type="number" class="qty-input" min="1" value="${detail.quantity_purchased}"></td>
        <td><input type="text" class="readonly unit-cost" value="${parseFloat(detail.unit_cost).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly cost-excl-tax" value="${parseFloat(detail.cost_excluding_tax).toFixed(2)}" readonly></td>
        <td><input type="number" class="tax-rate-input" step="0.01" min="0" value="${parseFloat(detail.tax_rate)}"></td>
        <td><input type="text" class="readonly total-tax" value="${parseFloat(detail.total_tax).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly cost-incl-tax" value="${parseFloat(detail.cost_including_tax).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly shipping-fees" value="${parseFloat(detail.shipping_fees).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly total-price" value="${parseFloat(detail.total_purchase_price).toFixed(2)}" readonly></td>
        <td>
          <button class="remove-item-btn" onclick="poDeleteItemRow(this, '${detail.detail_id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
      
      $(row).find('.item-name-select').select2({
        placeholder: 'Select Item',
        allowClear: true,
        dropdownParent: $('#poNewPOModal')
      }).on('change', function() {
        poItemChanged(this);
      });
      
      $(row).find('.qty-input, .tax-rate-input').on('input', function() {
        poCalculateRowTotals(row);
      });
    }

    // Delete item row (in edit mode)
    async function poDeleteItemRow(button, detailID) {
      if (!confirm('Are you sure you want to delete this item? This will update inventory quantities.')) {
        return;
      }
      
      showProcessing();
      try {
        const response = await fetch('/api/purchases/delete-detail/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify({ detail_id: detailID })
        });
        
        const result = await response.json();
        if (result.success) {
          button.closest('tr').remove();
          alert('Item deleted successfully');
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
      } finally {
        hideProcessing();
      }
    }

    // Search POs
    function poSearchPOs() {
      showProcessing();
      const criteria = document.getElementById('poSearchCriteria').value;
      const query = document.getElementById('poSearchInput').value.toLowerCase().trim();
      
      if (!query) {
        poFilteredPOs = [...poAllPOs];
      } else {
        poFilteredPOs = poAllPOs.filter(po => {
          if (criteria === 'all') {
            return (
              po.po_id.toLowerCase().includes(query) ||
              po.supplier_name.toLowerCase().includes(query) ||
              po.bill_number.toLowerCase().includes(query) ||
              (po.payment_status && po.payment_status.toLowerCase().includes(query)) ||
              (po.shipping_status && po.shipping_status.toLowerCase().includes(query))
            );
          } else if (criteria === 'PO ID') {
            return po.po_id.toLowerCase().includes(query);
          } else if (criteria === 'Supplier Name') {
            return po.supplier_name.toLowerCase().includes(query);
          } else if (criteria === 'Bill Num') {
            return po.bill_number.toLowerCase().includes(query);
          } else if (criteria === 'Payment Status') {
            return po.payment_status && po.payment_status.toLowerCase().includes(query);
          } else if (criteria === 'Shipping Status') {
            return po.shipping_status && po.shipping_status.toLowerCase().includes(query);
          }
          return true;
        });
      }
      
      poCurrentPage = 1;
      renderPOTable();
      
      if (poFilteredPOs.length === 0) {
        alert('No matching data found');
      }
      
      hideProcessing();
    }

    // Clear search
    function poClearSearch() {
      showProcessing();
      document.getElementById('poSearchInput').value = '';
      document.getElementById('poSearchCriteria').value = 'all';
      poFilteredPOs = [...poAllPOs];
      poCurrentPage = 1;
      renderPOTable();
      hideProcessing();
    }

    // Payment Status Modal
    function poOpenPMTStatusModal() {
      document.getElementById('poPMTStatusModal').style.display = 'block';
      document.getElementById('poNewPMTStatus').value = '';
    }

    function poClosePMTStatusModal() {
      document.getElementById('poPMTStatusModal').style.display = 'none';
    }

    async function poSaveNewPMTStatus() {
      const statusName = document.getElementById('poNewPMTStatus').value.trim();
      
      if (!statusName) {
        alert('Please enter a payment status');
        return;
      }
      
      showProcessing();
      try {
        const response = await fetch('/api/purchases/payment-statuses/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify({ status_name: statusName })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('Payment Status Added Successfully');
          poClosePMTStatusModal();
          await loadPMTStatuses();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving payment status:', error);
        alert('Failed to add payment status');
      } finally {
        hideProcessing();
      }
    }

    // Shipping Status Modal
    function poOpenShippingStatusModal() {
      document.getElementById('poShippingStatusModal').style.display = 'block';
      document.getElementById('poNewShippingStatus').value = '';
    }

    function poCloseShippingStatusModal() {
      document.getElementById('poShippingStatusModal').style.display = 'none';
    }

    async function poSaveNewShippingStatus() {
  const statusName = document.getElementById('poNewShippingStatus').value.trim();
  
  if (!statusName) {
    alert('Please enter a shipping status');
    return;
  }
  
  showProcessing();
  try {
    const response = await fetch('/api/purchases/shipping-statuses/add/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      credentials: 'same-origin',
      body: JSON.stringify({ status_name: statusName })
    });  // â† Fixed: Removed extra comma and closed the fetch properly
    
    const result = await response.json();
    if (result.success) {
      alert('Shipping Status Added Successfully');
      poCloseShippingStatusModal();
      await loadShippingStatuses();
    } else {
      alert('Error: ' + result.message);
    }
  } catch (error) {
    console.error('Error saving shipping status:', error);
    alert('Failed to add shipping status');
  } finally {
    hideProcessing();
  }
}

    // Utility functions
    function showProcessing() {
      document.getElementById('poProcessingOverlay').style.display = 'flex';
    }

    function hideProcessing() {
      document.getElementById('poProcessingOverlay').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const poModal = document.getElementById('poNewPOModal');
      const pmtModal = document.getElementById('poPMTStatusModal');
      const shipModal = document.getElementById('poShippingStatusModal');
      
      if (event.target === poModal) {
        poCloseNewPOModal();
      }
      if (event.target === pmtModal) {
        poClosePMTStatusModal();
      }
      if (event.target === shipModal) {
        poCloseShippingStatusModal();
      }
    }
  </script>

</body>
</html>