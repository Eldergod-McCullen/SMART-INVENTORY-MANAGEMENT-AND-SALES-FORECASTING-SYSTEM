{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% block title %} SUPPLIERS {% endblock %}</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
  
  <!--link rel="stylesheet" href="{% static 'Suppliers.css' %}"-->

  <style>
    .supplier-container {
    font-family: 'Roboto', sans-serif;
    padding: 20px;
    background-color: #f3f5f8;
    border-radius: 8px;
  }
  
  .supplier-header {
    margin-bottom: 25px;
  }
  
  .supplier-header h1 {
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
  }
  
  .supplier-header p {
    color: #7f8c8d;
    font-size: 1.05rem;
  }
  
  .action-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .btn-group {
    display: flex;
    gap: 30px;
  }
  
  .btn {
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-primary {
    background-color: #1abc9c;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #16a085;
  }
  
  .btn-secondary {
    background-color: #3498db;
    color: white;
  }
  
  .btn-secondary:hover {
    background-color: #2980b9;
  }
  
  .btn-outline {
    background-color: transparent;
    border: 1px solid #bdc3c7;
    color: #34495e;
  }
  
  .btn-outline:hover {
    background-color: #ecf0f1;
  }
  
  .search-group {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .search-select {
    padding: 9px;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    background-color: white;
  }
  
  .search-input {
    padding: 10px;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    width: 250px;
  }
  
  .supplier-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .supplier-table th {
    background-color: #2c3e50;
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
  }
  
  .supplier-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #ecf0f1;
    color: #34495e;
  }
  
  .supplier-table tr:hover {
    background-color: #f8f9fa;
  }
  
  .action-cell {
    display: flex;
    gap: 8px;
  }
  
  .action-btn {
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  
  .edit-btn {
    background-color: #3498db;
    color: white;
    border: none;
  }
  
  .update-btn {
    background-color: #2ecc71;
    color: white;
    border: none;
  }
  
  .cancel-btn {
    background-color: #95a5a6;
    color: white;
    border: none;
  }
  
  .delete-btn {
    background-color: #e74c3c;
    color: white;
    border: none;
  }
  
  .editable {
    background-color: #fffde7;
    border: 1px solid #ffd54f;
    padding: 5px;
    border-radius: 3px;
  }
                          
.supNoData{                                             /* ADDED STYLES FROM THE CLASS */
    display:none; 
    text-align:center; 
    padding:40px; 
    background:white; 
    border-radius:8px;
}
                                                   
.fas fa-inbox{                   
    font-size:3rem;   
    color:#bdc3c7; 
    margin-bottom:20px;
}

h3{ 
    color:#7f8c8d;
}

.modal{
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}
  
  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 25px;
    border-radius: 8px;
    width: 450px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #ecf0f1;
  }
  
  .modal-header h2 {
    font-family: 'Montserrat', sans-serif;
    color: #2c3e50;
    font-size: 1.5rem;
    margin: 0;
  }
  
  .close-btn {
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2c3e50;
  }
  
  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    font-family: 'Roboto', sans-serif;
  }
  
  .form-control:focus {
    border-color: #1abc9c;
    outline: none;
    box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
  }
  
  .required:after {
    content: " *";
    color: #e74c3c;
  }
  
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }
  
  .processing-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255,255,255,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  
  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #1abc9c;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .select2-container {
    width: 100% !important;
  }
  
  .id-generate {
    display: flex;
    gap: 10px;
  }
  
  .id-field {
    flex: 1;
  }
  
  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 5px;
  }
  
  .page-btn {
    padding: 8px 12px;
    background-color: white;
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .page-btn.active {
    background-color: #1abc9c;
    color: white;
    border-color: #1abc9c;
  }
  </style>

</head>

<body>
    <div class="supplier-container">

        <!-- Header Section -->
        <div class="supplier-header">
            <h1>ADD AND MANAGE YOUR SUPPLIERS</h1>
        </div>
  
        <!-- Action Bar -->
        <div class="action-bar">
            <div class="btn-group">
      <button class="btn btn-primary" onclick="supOpenNewSupplierModal()">
        <i class="fas fa-truck-loading"></i> New Supplier
      </button>
      <button class="btn btn-secondary" onclick="supOpenNewStateModal()">
        <i class="fa fa-map-marker"></i> New County
      </button>
      <button class="btn btn-secondary" onclick="supOpenNewCityModal()">
        <i class="fa fa-location-arrow"></i> New Town
      </button>
    </div>
    
    <div class="search-group">
      <select id="supSearchCriteria" class="search-select" title="search-select">
        <option value="all">All</option>
        <option value="Supplier Name">Supplier Name</option>
        <option value="State">County</option>
        <option value="City">Town</option>
      </select>
      <input type="text" id="supSearchInput" class="search-input" placeholder="Search...">
      <button class="btn btn-outline" onclick="supSearchSuppliers()">
        <i class="fas fa-search"></i> Search
      </button>
      <button class="btn btn-outline" onclick="supClearSearch()">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
  </div>
  
  <!-- Suppliers Table -->
  <div id="supTableContainer">
    <table class="supplier-table">
      <thead>
        <tr>
          <th width="5%">Supplier ID</th>
          <th width="15%">Supplier Name</th>
          <th width="8%">Phone Number</th>
          <th width="10%">E-Mail</th>
          <th width="7%">County</th>
          <th width="7%">Town</th>
          <th width="7%">Total Purchases</th>
          <th width="7%">Total Payments</th>
          <th width="7%">Balance Payable</th>
          <th width="7%">Actions</th>
        </tr>
      </thead>
      <tbody id="supTableBody">
        <!-- Data will be populated by JavaScript -->
      </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination" id="supPagination">
      <!-- Pagination buttons will be added here -->
    </div>
  </div>
  
  <!-- No Data Message -->
  <div id="supNoData" class="supNoData">
    <i class="fas fa-inbox"></i>
    <h3>No suppliers found</h3>
    <p>Click "New Supplier" to add a supplier</p>
  </div>
</div>

<!-- New County Modal -->
<div id="supStateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New County</h2>
      <span class="close-btn" onclick="supCloseStateModal()">&times;</span>
    </div>
    <div class="form-group">
      <label class="required">County Name</label>
      <input type="text" id="supNewState" class="form-control" title="supNewState" required>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="supCloseStateModal()">Close</button>
      <button class="btn btn-primary" onclick="supSaveNewState()">Save</button>
    </div>
  </div>
</div>

<!-- New Town Modal -->
<div id="supCityModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Town</h2>
      <span class="close-btn" onclick="supCloseCityModal()">&times;</span>
    </div>
    <div class="form-group">
      <label class="required">Town Name</label>
      <input type="text" id="supNewCity" class="form-control" title="supNewCity" required>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="supCloseCityModal()">Close</button>
      <button class="btn btn-primary" onclick="supSaveNewCity()">Save</button>
    </div>
  </div>
</div>

<!-- New Supplier Modal -->
<div id="supSupplierModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Supplier</h2>
      <span class="close-btn" onclick="supCloseSupplierModal()">&times;</span>
    </div>
    <div class="form-group">
      <label class="required">Supplier ID</label>
      <div class="id-generate">
        <input type="text" id="supSupplierId" class="form-control id-field" title="supSupplierId" readonly>
        <button class="btn btn-secondary" onclick="supGenerateSupplierId()">Generate</button>
      </div>
    </div>
    <div class="form-group">
      <label class="required">Supplier Name</label>
      <input type="text" id="supSupplierName" class="form-control" title="supSupplierName" required>
    </div>
    <div class="form-group">
      <label>Phone Number</label>
      <input type="text" id="supSupplierContact" class="form-control" title="supSupplierContact">
    </div>
    <div class="form-group">
      <label>E-Mail</label>
      <input type="email" id="supSupplierEmail" class="form-control" title="supSupplierEmail">
    </div>
    <div class="form-group">
      <label class="required">County</label>
      <select id="supSupplierState" class="form-control" title="supSupplierState"></select>
    </div>
    <div class="form-group">
      <label class="required">Town</label>
      <select id="supSupplierCity" class="form-control" title="supSupplierCity"></select>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="supCloseSupplierModal()">Close</button>
      <button class="btn btn-primary" onclick="supSaveNewSupplier()">Save</button>
    </div>
  </div>
</div>

<!-- Processing Overlay -->
<div id="supProcessingOverlay" class="processing-overlay">
  <div class="spinner"></div>
  <p>Processing...</p>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<!--script src="{% static 'Suppliers.js' %}"></!--script-->

<script>
 console.log('Suppliers.js loaded');

// Global variables
let supCurrentPage = 1;
const supPageSize = 25;
let supAllSuppliers = [];
let supFilteredSuppliers = [];
let supCounties = [];
let supTowns = [];

// CSRF Token helper
function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    return null;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing suppliers module...');
    
    loadCounties();
    loadTowns();
    loadSuppliers();
    
    // Initialize Select2 dropdowns
    $('#supSupplierState').select2({
        placeholder: 'Select County',
        allowClear: true
    });
    
    $('#supSupplierCity').select2({
        placeholder: 'Select Town',
        allowClear: true
    });
});

// ===================== LOAD DATA FUNCTIONS =====================

async function loadCounties() {
    try {
        const response = await fetch('/api/suppliers/counties/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            supCounties = result.data;
            populateCountyDropdown();
        }
    } catch (error) {
        console.error('Error loading counties:', error);
    }
}

async function loadTowns() {
    try {
        const response = await fetch('/api/suppliers/towns/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            supTowns = result.data;
            populateTownDropdown();
        }
    } catch (error) {
        console.error('Error loading towns:', error);
    }
}

function populateCountyDropdown() {
    const countySelect = $('#supSupplierState');
    countySelect.empty();
    countySelect.append(new Option('Select County', '', true, true));
    
    supCounties.forEach(county => {
        if (county) {
            countySelect.append(new Option(county, county));
        }
    });
    
    countySelect.trigger('change');
}

function populateTownDropdown() {
    const townSelect = $('#supSupplierCity');
    townSelect.empty();
    townSelect.append(new Option('Select Town', '', true, true));
    
    supTowns.forEach(town => {
        if (town) {
            townSelect.append(new Option(town, town));
        }
    });
    
    townSelect.trigger('change');
}

async function loadSuppliers() {
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            supAllSuppliers = result.data;
            supFilteredSuppliers = [...result.data];
            renderSupplierTable();
        } else {
            alert('Error loading suppliers: ' + result.message);
        }
    } catch (error) {
        console.error('Error loading suppliers:', error);
        alert('Failed to load suppliers');
    } finally {
        hideProcessing();
    }
}

// ===================== RENDER TABLE & PAGINATION =====================

function renderSupplierTable() {
    const startIndex = (supCurrentPage - 1) * supPageSize;
    const endIndex = startIndex + supPageSize;
    const pageSuppliers = supFilteredSuppliers.slice(startIndex, endIndex);
    const tableBody = document.getElementById('supTableBody');
    
    tableBody.innerHTML = '';
    
    if (pageSuppliers.length === 0) {
        document.getElementById('supTableContainer').style.display = 'none';
        document.getElementById('supNoData').style.display = 'block';
        document.getElementById('supPagination').innerHTML = '';
        return;
    }
    
    document.getElementById('supTableContainer').style.display = 'block';
    document.getElementById('supNoData').style.display = 'none';
    
    pageSuppliers.forEach((supplier, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-supplier-id', supplier.id);
        row.setAttribute('data-index', index);
        
        row.innerHTML = `
            <td class="col-id">${supplier.id}</td>
            <td class="col-name">${supplier.name}</td>
            <td class="col-contact">${supplier.contact || ''}</td>
            <td class="col-email">${supplier.email || ''}</td>
            <td class="col-state">${supplier.state}</td>
            <td class="col-city">${supplier.city}</td>
            <td class="col-purchases">${parseFloat(supplier.purchases).toFixed(2)}</td>
            <td class="col-payments">${parseFloat(supplier.payments).toFixed(2)}</td>
            <td class="col-balance">${parseFloat(supplier.balance).toFixed(2)}</td>
            <td class="action-cell">
                <button class="action-btn edit-btn" data-supplier-id="${supplier.id}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" data-supplier-id="${supplier.id}">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="action-btn update-btn" style="display:none;" data-supplier-id="${supplier.id}">
                    <i class="fas fa-save"></i>
                </button>
                <button class="action-btn cancel-btn" style="display:none;" data-supplier-id="${supplier.id}">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        
        // Add event listeners
        row.querySelector('.edit-btn').addEventListener('click', function() {
            editSupplier(this);
        });
        row.querySelector('.delete-btn').addEventListener('click', function() {
            deleteSupplier(this.getAttribute('data-supplier-id'));
        });
        row.querySelector('.update-btn').addEventListener('click', function() {
            updateSupplier(this);
        });
        row.querySelector('.cancel-btn').addEventListener('click', function() {
            cancelEdit(this);
        });
        
        tableBody.appendChild(row);
    });
    
    renderPagination();
}

function renderPagination() {
    const totalPages = Math.ceil(supFilteredSuppliers.length / supPageSize);
    const paginationDiv = document.getElementById('supPagination');
    paginationDiv.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = supCurrentPage === 1;
    prevBtn.onclick = () => {
        if (supCurrentPage > 1) {
            supCurrentPage--;
            renderSupplierTable();
        }
    };
    paginationDiv.appendChild(prevBtn);
    
    // Page buttons
    for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === supCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
            supCurrentPage = i;
            renderSupplierTable();
        };
        paginationDiv.appendChild(pageBtn);
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = supCurrentPage === totalPages;
    nextBtn.onclick = () => {
        if (supCurrentPage < totalPages) {
            supCurrentPage++;
            renderSupplierTable();
        }
    };
    paginationDiv.appendChild(nextBtn);
}

// ===================== COUNTY MODAL FUNCTIONS =====================

function supOpenNewStateModal() {
    document.getElementById('supStateModal').style.display = 'block';
    document.getElementById('supNewState').value = '';
}

function supCloseStateModal() {
    document.getElementById('supStateModal').style.display = 'none';
}

async function supSaveNewState() {
    const countyName = document.getElementById('supNewState').value.trim();
    
    if (!countyName) {
        alert('Please enter a county name');
        return;
    }
    
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/counties/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({ county_name: countyName })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('County Added Successfully');
            supCloseStateModal();
            await loadCounties();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving county:', error);
        alert('Failed to add county');
    } finally {
        hideProcessing();
    }
}

// ===================== TOWN MODAL FUNCTIONS =====================

function supOpenNewCityModal() {
    document.getElementById('supCityModal').style.display = 'block';
    document.getElementById('supNewCity').value = '';
}

function supCloseCityModal() {
    document.getElementById('supCityModal').style.display = 'none';
}

async function supSaveNewCity() {
    const townName = document.getElementById('supNewCity').value.trim();
    
    if (!townName) {
        alert('Please enter a town name');
        return;
    }
    
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/towns/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({ town_name: townName })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Town Added Successfully');
            supCloseCityModal();
            await loadTowns();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving town:', error);
        alert('Failed to add town');
    } finally {
        hideProcessing();
    }
}

// ===================== SUPPLIER MODAL FUNCTIONS =====================

function supOpenNewSupplierModal() {
    document.getElementById('supSupplierModal').style.display = 'block';
    document.getElementById('supSupplierId').value = '';
    document.getElementById('supSupplierName').value = '';
    document.getElementById('supSupplierContact').value = '';
    document.getElementById('supSupplierEmail').value = '';
    $('#supSupplierState').val('').trigger('change');
    $('#supSupplierCity').val('').trigger('change');
}

function supCloseSupplierModal() {
    document.getElementById('supSupplierModal').style.display = 'none';
}

async function supGenerateSupplierId() {
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/generate-id/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('supSupplierId').value = result.supplier_id;
        } else {
            alert('Error generating ID: ' + result.message);
        }
    } catch (error) {
        console.error('Error generating supplier ID:', error);
        alert('Failed to generate supplier ID');
    } finally {
        hideProcessing();
    }
}

async function supSaveNewSupplier() {
    const supplierData = {
        id: document.getElementById('supSupplierId').value.trim(),
        name: document.getElementById('supSupplierName').value.trim(),
        contact: document.getElementById('supSupplierContact').value.trim(),
        email: document.getElementById('supSupplierEmail').value.trim(),
        state: $('#supSupplierState').val(),
        city: $('#supSupplierCity').val()
    };
    
    // Validation
    if (!supplierData.id) {
        alert('Please generate a Supplier ID');
        return;
    }
    if (!supplierData.name) {
        alert('Please enter Supplier Name');
        return;
    }
    if (!supplierData.state) {
        alert('Please select County');
        return;
    }
    if (!supplierData.city) {
        alert('Please select Town');
        return;
    }
    
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify(supplierData)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Supplier Saved Successfully');
            supCloseSupplierModal();
            await loadSuppliers();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving supplier:', error);
        alert('Failed to save supplier');
    } finally {
        hideProcessing();
    }
}

// ===================== EDIT, UPDATE, CANCEL FUNCTIONS =====================

function editSupplier(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    
    // Store original values
    row.setAttribute('data-original-name', cells[1].textContent);
    row.setAttribute('data-original-contact', cells[2].textContent);
    row.setAttribute('data-original-email', cells[3].textContent);
    row.setAttribute('data-original-state', cells[4].textContent);
    row.setAttribute('data-original-city', cells[5].textContent);
    
    // Make editable
    cells[1].innerHTML = `<input type="text" class="editable" value="${cells[1].textContent}">`;
    cells[2].innerHTML = `<input type="text" class="editable" value="${cells[2].textContent}">`;
    cells[3].innerHTML = `<input type="email" class="editable" value="${cells[3].textContent}">`;
    
    // County dropdown
    let countyOptions = supCounties.map(county => 
        `<option value="${county}" ${county === cells[4].textContent ? 'selected' : ''}>${county}</option>`
    ).join('');
    cells[4].innerHTML = `<select class="editable" style="width:100%">${countyOptions}</select>`;
    
    // Town dropdown
    let townOptions = supTowns.map(town => 
        `<option value="${town}" ${town === cells[5].textContent ? 'selected' : ''}>${town}</option>`
    ).join('');
    cells[5].innerHTML = `<select class="editable" style="width:100%">${townOptions}</select>`;
    
    // Show/hide buttons
    const actionCell = cells[9];
    actionCell.querySelector('.edit-btn').style.display = 'none';
    actionCell.querySelector('.delete-btn').style.display = 'none';
    actionCell.querySelector('.update-btn').style.display = 'inline-block';
    actionCell.querySelector('.cancel-btn').style.display = 'inline-block';
}

function cancelEdit(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    
    // Restore original values
    cells[1].textContent = row.getAttribute('data-original-name');
    cells[2].textContent = row.getAttribute('data-original-contact');
    cells[3].textContent = row.getAttribute('data-original-email');
    cells[4].textContent = row.getAttribute('data-original-state');
    cells[5].textContent = row.getAttribute('data-original-city');
    
    // Show/hide buttons
    const actionCell = cells[9];
    actionCell.querySelector('.edit-btn').style.display = 'inline-block';
    actionCell.querySelector('.delete-btn').style.display = 'inline-block';
    actionCell.querySelector('.update-btn').style.display = 'none';
    actionCell.querySelector('.cancel-btn').style.display = 'none';
}

async function updateSupplier(button) {
    const row = button.closest('tr');
    const cells = row.querySelectorAll('td');
    const supplierId = row.getAttribute('data-supplier-id');
    
    const supplierData = {
        id: supplierId,
        name: cells[1].querySelector('input').value.trim(),
        contact: cells[2].querySelector('input').value.trim(),
        email: cells[3].querySelector('input').value.trim(),
        state: cells[4].querySelector('select').value,
        city: cells[5].querySelector('select').value
    };
    
    // Validation
    if (!supplierData.name || !supplierData.state || !supplierData.city) {
        alert('Please fill all required fields');
        return;
    }
    
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify(supplierData)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Supplier Updated Successfully');
            await loadSuppliers();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error updating supplier:', error);
        alert('Failed to update supplier');
    } finally {
        hideProcessing();
    }
}

// ===================== DELETE FUNCTION =====================

async function deleteSupplier(supplierId) {
    if (!confirm('Are you sure you want to delete this supplier?')) {
        return;
    }
    
    showProcessing();
    try {
        const response = await fetch('/api/suppliers/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({ supplier_id: supplierId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Supplier Deleted Successfully');
            await loadSuppliers();
        } else {
            if (result.has_balance) {
                alert('YOU HAVE A BALANCE WITH THIS SUPPLIER. YOU CANNOT DELETE THEM UNTIL ALL DUES ARE CLEARED.');
            } else {
                alert('Error: ' + result.message);
            }
        }
    } catch (error) {
        console.error('Error deleting supplier:', error);
        alert('Failed to delete supplier');
    } finally {
        hideProcessing();
    }
}

// ===================== SEARCH FUNCTIONS =====================

function supSearchSuppliers() {
    const criteria = document.getElementById('supSearchCriteria').value;
    const query = document.getElementById('supSearchInput').value.toLowerCase().trim();
    
    if (!query) {
        supFilteredSuppliers = [...supAllSuppliers];
    } else {
        supFilteredSuppliers = supAllSuppliers.filter(supplier => {
            if (criteria === 'all') {
                return (
                    supplier.name.toLowerCase().includes(query) ||
                    (supplier.state && supplier.state.toLowerCase().includes(query)) ||
                    (supplier.city && supplier.city.toLowerCase().includes(query))
                );
            } else if (criteria === 'Supplier Name') {
                return supplier.name.toLowerCase().includes(query);
            } else if (criteria === 'State') {
                return supplier.state && supplier.state.toLowerCase().includes(query);
            } else if (criteria === 'City') {
                return supplier.city && supplier.city.toLowerCase().includes(query);
            }
            return true;
        });
    }
    
    supCurrentPage = 1;
    renderSupplierTable();
    
    if (supFilteredSuppliers.length === 0) {
        alert('No matching data found');
    }
}

function supClearSearch() {
    document.getElementById('supSearchInput').value = '';
    document.getElementById('supSearchCriteria').value = 'all';
    supFilteredSuppliers = [...supAllSuppliers];
    supCurrentPage = 1;
    renderSupplierTable();
}

// ===================== UTILITY FUNCTIONS =====================

function showProcessing() {
    document.getElementById('supProcessingOverlay').style.display = 'flex';
}

function hideProcessing() {
    document.getElementById('supProcessingOverlay').style.display = 'none';
}
</script>


</body>
</html>