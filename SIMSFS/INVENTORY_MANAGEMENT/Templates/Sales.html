{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% block title %}SALES ORDERS{% endblock %}</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Select2 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
  
  <!-- Flatpickr (Date Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root {
      --primary: #1abc9c;
      --primary-light: #d1f2eb;
      --primary-dark: #16a085;
      --secondary: #3498db;
      --dark: #2c3e50;
      --light-dark: #34495e;
      --gray: #7f8c8d;
      --light-gray: #ecf0f1;
      --white: #ffffff;
      --error: #e74c3c;
      --warning: #f39c12;
      --success: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: var(--light-dark);
    }
    
    .sales-container {
      max-width: 1600px;
      margin: 0 auto;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      padding: 25px;
    }
    
    .header-section {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .header-section h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .btn-secondary:hover {
      background-color: #2980b9;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid #bdc3c7;
      color: var(--light-dark);
    }
    
    .btn-outline:hover {
      background-color: var(--light-gray);
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .search-select {
      padding: 9px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      background-color: var(--white);
      min-width: 160px;
    }
    
    .search-input {
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      width: 250px;
    }
    
    .sales-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--white);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .sales-table th {
      background-color: var(--dark);
      color: var(--white);
      padding: 14px 16px;
      text-align: left;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    .sales-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--light-gray);
      color: var(--light-dark);
      font-size: 0.92rem;
    }
    
    .sales-table tr:hover {
      background-color: rgba(26, 188, 156, 0.05);
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      color: white;
    }
    
    .view-btn {
      background-color: #3498db;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 0;
      padding: 30px;
      width: 100vw;
      height: 100vh;
      overflow: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-header h2 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 1.6rem;
      margin: 0;
    }
    
    .close-btn {
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: color 0.3s;
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background-color: #fafafa;
    }
    
    .form-section h3 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }

    .no-data-container {
      display: none;
      text-align: center;
      padding: 50px 20px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 20px;
    }

    .items-table {
      width: max-content;
      table-layout: auto;
      border-collapse: collapse;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-control {
      width: 100%;
      padding: 11px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95rem;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
    }
    
    .required:after {
      content: " *";
      color: var(--error);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }
    
    .processing-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .select2-container {
      width: 100% !important;
    }
    
    .id-generate {
      display: flex;
      gap: 10px;
    }
    
    .id-field {
      flex: 1;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 25px;
      gap: 6px;
    }
    
    .page-btn {
      padding: 8px 14px;
      background-color: var(--white);
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Roboto', sans-serif;
      transition: all 0.3s;
    }
    
    .page-btn:hover:not(.active) {
      background-color: var(--light-gray);
    }
    
    .page-btn.active {
      background-color: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }
    
    .no-data-icon {
      font-size: 3.5rem;
      color: #bdc3c7;
      margin-bottom: 20px;
    }
    
    .no-data-title {
      color: var(--gray);
      margin-bottom: 10px;
      font-family: 'Montserrat', sans-serif;
    }
    
    .items-table th, .items-table td {
      padding: 8px 12px;
      white-space: nowrap;
    }

    .items-table input, .items-table select {
      width: 100%;
      min-width: 100px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table input:focus, .items-table select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .items-table .readonly {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table-container {
      max-height: auto;
      overflow-x: auto;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-top: 15px;
      margin-bottom: 20px;
    }
    
    .add-item-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 10px;
    }
    
    .remove-item-btn {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>
  <div class="sales-container">
    <!-- Header Section -->
    <div class="header-section">
      <h1>CREATE AND MANAGE YOUR SALES ORDERS AND THEIR DETAILS</h1>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="soOpenNewSOModal()">
          <i class="fas fa-file-invoice"></i> New Sales Order
        </button>
        <button class="btn btn-secondary" onclick="soOpenReceiptStatusModal()">
          <i class="fas fa-money-bill-wave"></i> New Receipt Status
        </button>
        <button class="btn btn-secondary" onclick="soOpenShippingStatusModal()">
          <i class="fas fa-truck"></i> New Shipping Status
        </button>
      </div>
      
      <div class="search-group">
        <select id="soSearchCriteria" class="search-select" title="soSearchCriteria">
          <option value="all">All</option>
          <option value="SO ID">SO ID</option>
          <option value="Customer Name">Customer Name</option>
          <option value="Invoice Num">Invoice Number</option>
          <option value="Receipt Status">Receipt Status</option>
          <option value="Shipping Status">Shipping Status</option>
        </select>
        <input type="text" id="soSearchInput" class="search-input" placeholder="Search...">
        <button class="btn btn-outline" onclick="soSearchSOs()">
          <i class="fas fa-search"></i> Search
        </button>
        <button class="btn btn-outline" onclick="soClearSearch()">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>
    
    <!-- Sales Orders Table -->
    <div id="soTableContainer">
      <table class="sales-table">
        <thead>
          <tr>
            <th>SO ID</th>
            <th>Date</th>
            <th>Customer ID</th>
            <th>Customer Name</th>
            <th>Invoice Number</th>
            <th>County</th>
            <th>Town</th>
            <th>Total Amount</th>
            <th>Amount Received</th>
            <th>SO Balance</th>
            <th>Receipt Status</th>
            <th>Shipping Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="soTableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="pagination" id="soPagination">
        <!-- Pagination buttons will be added here -->
      </div>
    </div>
    
    <!-- No Data Message -->
    <div id="soNoData" class="no-data-container">
      <i class="fas fa-inbox no-data-icon"></i>
      <h3 class="no-data-title">No sales orders found</h3>
      <p>Click "New Sales Order" to create a sales order</p>
    </div>
  </div>
  
  <!-- Receipt Status Modal -->
  <div id="soReceiptStatusModal" class="modal">
    <div class="modal-content" style="width: 450px; height: auto; margin: 5% auto;">
      <div class="modal-header">
        <h2>Configure Receipt Status</h2>
        <span class="close-btn" onclick="soCloseReceiptStatusModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Receipt Status</label>
        <input type="text" id="soNewReceiptStatus" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="soCloseReceiptStatusModal()">Close</button>
        <button class="btn btn-primary" onclick="soSaveNewReceiptStatus()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Shipping Status Modal -->
  <div id="soShippingStatusModal" class="modal">
    <div class="modal-content" style="width: 450px; height: auto; margin: 5% auto;">
      <div class="modal-header">
        <h2>Configure Shipping Status</h2>
        <span class="close-btn" onclick="soCloseShippingStatusModal()">&times;</span>
      </div>
      <div class="form-group">
        <label class="required">Shipping Status</label>
        <input type="text" id="soNewShippingStatus" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="soCloseShippingStatusModal()">Close</button>
        <button class="btn btn-primary" onclick="soSaveNewShippingStatus()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- New/Edit SO Modal -->
  <div id="soNewSOModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="soModalTitle">Create New Sales Order</h2>
        <span class="close-btn" onclick="soCloseNewSOModal()">&times;</span>
      </div>
      
      <!-- Section 1: SO Header -->
      <div class="form-section">
        <h3>SO Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="required">SO ID</label>
            <div class="id-generate">
              <input type="text" id="soSOID" class="form-control id-field" readonly>
              <button class="btn btn-secondary" onclick="soGenerateSOID()" id="soGenerateBtn">Generate</button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="required">SO Date</label>
            <input type="text" id="soSODate" class="form-control date-picker" placeholder="DD/MM/YYYY">
          </div>
          
          <div class="form-group">
            <label class="required">Customer Name</label>
            <select id="soCustomerName" class="form-control"></select>
          </div>
          
          <div class="form-group">
            <label class="required">Customer ID</label>
            <input type="text" id="soCustomerID" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">County</label>
            <input type="text" id="soCounty" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">Town</label>
            <input type="text" id="soTown" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">Invoice Number</label>
            <input type="text" id="soInvoiceNum" class="form-control" readonly>
          </div>
        </div>
      </div>
      
      <!-- Section 2: SO Items -->
      <div class="form-section">
        <h3>SO Items</h3>
        <button class="add-item-btn" onclick="soAddItemRow()">
          <i class="fas fa-plus"></i> Add Item
        </button>
        
        <div class="items-table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>SO ID</th>
                <th>Detail ID</th>
                <th>Customer ID</th>
                <th>Customer Name</th>
                <th>County</th>
                <th>Town</th>
                <th>Invoice Number</th>
                <th>Item ID</th>
                <th>Item Type</th>
                <th>Item Category</th>
                <th>Item Subcategory</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Price Excluding Tax</th>
                <th>Tax Rate (%)</th>
                <th>Total Tax</th>
                <th>Price Inclusive of Tax</th>
                <th>Shipping Fees</th>
                <th>Total Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="soItemsTableBody">
              <!-- Item rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="soCloseNewSOModal()">Close</button>
        <button class="btn btn-primary" onclick="soSaveNewSO()" id="soSaveBtn">Save SO</button>
      </div>
    </div>
  </div>
  
  <!-- Processing Overlay -->
  <div id="soProcessingOverlay" class="processing-overlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    console.log('Sales.js loaded');

    // Global variables
    let soCurrentPage = 1;
    const soPageSize = 25;
    let soAllSOs = [];
    let soFilteredSOs = [];
    let soCustomers = [];
    let soInventoryItems = [];
    let soReceiptStatuses = [];
    let soShippingStatuses = [];
    let soIsEditMode = false;
    let soCurrentSOID = null;
    let soDetailCounter = 1;

    let soNextDetailNumber = null;           // GLOBAL VARIABLE TO TRACK THE NEXT DETAIL NUMBER IN THE CURRENT SESSION

    // CSRF Token
    function getCSRFToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
      }
      return null;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing sales...');
      loadCustomers();
      loadInventoryItems();
      loadReceiptStatuses();
      loadShippingStatuses();
      loadSalesOrders();
      initializeDatePicker();
      loadNextSalesDetailNumber()
    });

    // Initialize Flatpickr date picker
    function initializeDatePicker() {
      flatpickr("#soSODate", {
        dateFormat: "d/m/Y",
        allowInput: true
      });
    }

    // Load customers
    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soCustomers = result.data;
          populateCustomerDropdown();
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    // Populate customer dropdown
    function populateCustomerDropdown() {
      const customerSelect = $('#soCustomerName');
      customerSelect.empty();
      customerSelect.append(new Option('Select Customer', '', true, true));
      
      soCustomers.forEach(customer => {
        if (customer) {
          customerSelect.append(new Option(customer.name, customer.name));
        }
      });
      
      customerSelect.select2({
        placeholder: 'Select Customer',
        allowClear: true,
        dropdownParent: $('#soNewSOModal')
      });

      customerSelect.on('change', function() {
        soCustomerChanged();
      });
    }

    // Customer changed event
    function soCustomerChanged() {
      const customerName = $('#soCustomerName').val();
      const customer = soCustomers.find(c => c.name === customerName);
      
      if (customer) {
        $('#soCustomerID').val(customer.id);
        $('#soCounty').val(customer.state);
        $('#soTown').val(customer.city);
        
        // Update all item rows
        updateAllItemRowsWithHeaderData();
      } else {
        $('#soCustomerID').val('');
        $('#soCounty').val('');
        $('#soTown').val('');
      }
    }

    // Load inventory items
    async function loadInventoryItems() {
      try {
        const response = await fetch('/api/inventory-items/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soInventoryItems = result.data;
        }
      } catch (error) {
        console.error('Error loading inventory items:', error);
      }
    }

    // Load receipt statuses
    async function loadReceiptStatuses() {
      try {
        const response = await fetch('/api/sales/receipt-statuses/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soReceiptStatuses = result.data;
        }
      } catch (error) {
        console.error('Error loading receipt statuses:', error);
      }
    }

    // Load shipping statuses
    async function loadShippingStatuses() {
      try {
        const response = await fetch('/api/sales/shipping-statuses/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soShippingStatuses = result.data;
        }
      } catch (error) {
        console.error('Error loading shipping statuses:', error);
      }
    }

    // Load sales orders
    async function loadSalesOrders() {
      showProcessing();
      try {
        const response = await fetch('/api/sales/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soAllSOs = result.data;
          soFilteredSOs = [...result.data];
          renderSOTable();
        } else {
          alert('Error loading sales orders: ' + result.message);
        }
      } catch (error) {
        console.error('Error loading sales orders:', error);
        alert('Failed to load sales orders');
      } finally {
        hideProcessing();
      }
    }

    // Load the next detail number when page loads
async function loadNextSalesDetailNumber() {
  try {
    const response = await fetch('/api/sales/get-next-detail-number/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    if (result.success) {
      soNextDetailNumber = result.next_number;
      console.log(`ðŸ“Š Loaded next Sales Detail number: ${soNextDetailNumber}`);
    }
  } catch (error) {
    console.error('Error loading next detail number:', error);
    soNextDetailNumber = 1;
  }
}

    // Render SO table
    function renderSOTable() {
      const startIndex = (soCurrentPage - 1) * soPageSize;
      const endIndex = startIndex + soPageSize;
      const pageSOs = soFilteredSOs.slice(startIndex, endIndex);
      const tableBody = document.getElementById('soTableBody');
      
      tableBody.innerHTML = '';
      
      if (pageSOs.length === 0) {
        document.getElementById('soTableContainer').style.display = 'none';
        document.getElementById('soNoData').style.display = 'block';
        document.getElementById('soPagination').innerHTML = '';
        return;
      }
      
      document.getElementById('soTableContainer').style.display = 'block';
      document.getElementById('soNoData').style.display = 'none';
      
      pageSOs.forEach((so) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${so.so_id}</td>
          <td>${so.date}</td>
          <td>${so.customer_id}</td>
          <td>${so.customer_name}</td>
          <td>${so.invoice_number}</td>
          <td>${so.county || ''}</td>
          <td>${so.town || ''}</td>
          <td>${parseFloat(so.total_amount).toFixed(2)}</td>
          <td>${parseFloat(so.amount_received).toFixed(2)}</td>
          <td>${parseFloat(so.balance_left).toFixed(2)}</td>
          <td>${so.receipt_status || ''}</td>
          <td>${so.shipping_status || ''}</td>
          <td class="action-cell">
            <button class="action-btn view-btn" onclick="soViewSO('${so.so_id}')">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      renderSOPagination();
    }

    // Render pagination
    function renderSOPagination() {
      const totalPages = Math.ceil(soFilteredSOs.length / soPageSize);
      const paginationDiv = document.getElementById('soPagination');
      paginationDiv.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = soCurrentPage === 1;
      prevBtn.onclick = () => {
        if (soCurrentPage > 1) {
          soCurrentPage--;
          renderSOTable();
        }
      };
      paginationDiv.appendChild(prevBtn);
      
      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === soCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
          soCurrentPage = i;
          renderSOTable();
        };
        paginationDiv.appendChild(pageBtn);
      }
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = soCurrentPage === totalPages;
      nextBtn.onclick = () => {
        if (soCurrentPage < totalPages) {
          soCurrentPage++;
          renderSOTable();
        }
      };
      paginationDiv.appendChild(nextBtn);
    }

    // Open new SO modal
    function soOpenNewSOModal() {
      soIsEditMode = false;
      soCurrentSOID = null;
      document.getElementById('soModalTitle').textContent = 'Create New Sales Order';
      document.getElementById('soSaveBtn').textContent = 'Save SO';
      document.getElementById('soGenerateBtn').style.display = 'inline-block';
      
      // Clear form
      document.getElementById('soSOID').value = '';
      document.getElementById('soSODate').value = '';
      $('#soCustomerName').val('').trigger('change');
      document.getElementById('soCustomerID').value = '';
      document.getElementById('soCounty').value = '';
      document.getElementById('soTown').value = '';
      document.getElementById('soInvoiceNum').value = '';
      document.getElementById('soItemsTableBody').innerHTML = '';
      
      soDetailCounter = 1;
      document.getElementById('soNewSOModal').style.display = 'block';
    }

    // Close SO modal
    function soCloseNewSOModal() {
      document.getElementById('soNewSOModal').style.display = 'none';
    }

    // Generate SO ID
    async function soGenerateSOID() {
      showProcessing();
      try {
        const response = await fetch('/api/sales/generate-so-id/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('soSOID').value = result.so_id;
          document.getElementById('soInvoiceNum').value = result.invoice_number;
          
          // Update all item rows
          updateAllItemRowsWithHeaderData();
        } else {
          alert('Error generating SO ID: ' + result.message);
        }
      } catch (error) {
        console.error('Error generating SO ID:', error);
        alert('Failed to generate SO ID');
      } finally {
        hideProcessing();
      }
    }

// âœ… FOR SALES MODULE - Fixed soAddItemRow function
async function soAddItemRow() {
  const soID = document.getElementById('soSOID').value;
  const soDate = document.getElementById('soSODate').value;
  const customerID = document.getElementById('soCustomerID').value;
  const customerName = $('#soCustomerName').val();
  const county = document.getElementById('soCounty').value;
  const town = document.getElementById('soTown').value;
  const invoiceNum = document.getElementById('soInvoiceNum').value;
  
  if (!soID || !soDate || !customerName) {
    alert('Please fill SO ID, Date, and Customer Name first');
    return;
  }
  
  // ðŸŽ¯ CHECK: Get all existing Detail IDs in the current table FIRST
  const existingDetailIDs = new Set();
  $('#soItemsTableBody tr').each(function() {
    const detailID = $(this).attr('data-detail-id');
    if (detailID) {
      existingDetailIDs.add(detailID);
      // Extract number and update our counter if needed
      const num = parseInt(detailID.substring(2));
      if (num >= soNextDetailNumber) {
        soNextDetailNumber = num + 1;
      }
    }
  });
  
  // ðŸŽ¯ GENERATE THE NEXT DETAIL ID
  let detailID = `SD${soNextDetailNumber.toString().padStart(5, '0')}`;
  
  // ðŸŽ¯ ENSURE IT'S UNIQUE (safety check)
  while (existingDetailIDs.has(detailID)) {
    soNextDetailNumber++;
    detailID = `SD${soNextDetailNumber.toString().padStart(5, '0')}`;
  }
  
  // ðŸŽ¯ INCREMENT FOR NEXT CALL
  soNextDetailNumber++;
  
  console.log(`ðŸ†• Generated SALES Detail ID: ${detailID} at ${new Date().toLocaleTimeString()}`);
  
  const tbody = document.getElementById('soItemsTableBody');
    const row = document.createElement('tr');
    row.setAttribute('data-detail-id', detailID);
    
    // Create item name dropdown
    let itemOptions = '<option value="">Select Item</option>';
    soInventoryItems.forEach(item => {
      itemOptions += `<option value="${item.name}" data-item-id="${item.id}" data-type="${item.type}" data-category="${item.category}" data-subcategory="${item.subcategory}" data-sale-price="${item.sale_price}">${item.name}</option>`;
    });
    
    row.innerHTML = `
      <td><input type="text" class="readonly" value="${soDate}" readonly></td>
      <td><input type="text" class="readonly" value="${soID}" readonly></td>
      <td><input type="text" class="readonly" value="${detailID}" readonly></td>
      <td><input type="text" class="readonly" value="${customerID}" readonly></td>
      <td><input type="text" class="readonly" value="${customerName}" readonly></td>
      <td><input type="text" class="readonly" value="${county}" readonly></td>
      <td><input type="text" class="readonly" value="${town}" readonly></td>
      <td><input type="text" class="readonly" value="${invoiceNum}" readonly></td>
      <td><input type="text" class="readonly item-id" value="" readonly></td>
      <td><input type="text" class="readonly item-type" value="" readonly></td>
      <td><input type="text" class="readonly item-category" value="" readonly></td>
      <td><input type="text" class="readonly item-subcategory" value="" readonly></td>
      <td><select class="item-name-select" style="min-width: 200px;">${itemOptions}</select></td>
      <td><input type="number" class="qty-input" min="1" value="1"></td>
      <td><input type="text" class="readonly unit-price" value="0.00" readonly></td>
      <td><input type="text" class="readonly price-excl-tax" value="0.00" readonly></td>
      <td><input type="number" class="tax-rate-input" step="0.01" min="0" value="0"></td>
      <td><input type="text" class="readonly total-tax" value="0.00" readonly></td>
      <td><input type="text" class="readonly price-incl-tax" value="0.00" readonly></td>
      <td><input type="text" class="readonly shipping-fees" value="0.00" readonly></td>
      <td><input type="text" class="readonly total-price" value="0.00" readonly></td>
      <td>
        <button class="remove-item-btn" onclick="soRemoveItemRow(this)">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
    
    // Initialize Select2
    $(row).find('.item-name-select').select2({
      placeholder: 'Select Item',
      allowClear: true,
      dropdownParent: $('#soNewSOModal')
    }).on('change', function() {
      soItemChanged(this);
    });
    
    // Add calculation listeners
    $(row).find('.qty-input, .tax-rate-input').on('input', function() {
      soCalculateRowTotals(row);
    });
}

// ============================================================
// VERIFICATION HELPER - Add this function to test
// ============================================================
async function testDetailIDGeneration() {
  console.log("\nðŸ§ª TESTING DETAIL ID GENERATION\n");
  
  for (let i = 1; i <= 5; i++) {
    const timestamp = new Date().getTime();
    
    try {
      // Test Sales
      const salesResponse = await fetch(`/api/sales/generate-detail-id/?t=${timestamp}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin',
        cache: 'no-store'
      });
      
      const salesResult = await salesResponse.json();
      console.log(`Test ${i} - Sales Detail ID: ${salesResult.detail_id}`);
      
      // Test Purchases
      const purchasesResponse = await fetch(`/api/purchases/generate-detail-id/?t=${timestamp + 1}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin',
        cache: 'no-store'
      });
      
      const purchasesResult = await purchasesResponse.json();
      console.log(`Test ${i} - Purchases Detail ID: ${purchasesResult.detail_id}\n`);
      
    } catch (error) {
      console.error(`Test ${i} failed:`, error);
    }
  }
  
  console.log("âœ… Test Complete\n");
}

// To run the test, open browser console and type: testDetailIDGeneration()

    // Item changed event
    function soItemChanged(selectElement) {
      const row = selectElement.closest('tr');
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      
      if (selectedOption.value) {
        const itemID = selectedOption.getAttribute('data-item-id');
        const itemType = selectedOption.getAttribute('data-type');
        const itemCategory = selectedOption.getAttribute('data-category');
        const itemSubcategory = selectedOption.getAttribute('data-subcategory');
        const salePrice = parseFloat(selectedOption.getAttribute('data-sale-price')) || 0;
        
        $(row).find('.item-id').val(itemID);
        $(row).find('.item-type').val(itemType);
        $(row).find('.item-category').val(itemCategory);
        $(row).find('.item-subcategory').val(itemSubcategory);
        $(row).find('.unit-price').val(salePrice.toFixed(2));
        
        soCalculateRowTotals(row);
      } else {
        $(row).find('.item-id').val('');
        $(row).find('.item-type').val('');
        $(row).find('.item-category').val('');
        $(row).find('.item-subcategory').val('');
        $(row).find('.unit-price').val('0.00');
        soCalculateRowTotals(row);
      }
    }

    // Calculate row totals
    function soCalculateRowTotals(row) {
      const qty = parseFloat($(row).find('.qty-input').val()) || 0;
      const unitPrice = parseFloat($(row).find('.unit-price').val()) || 0;
      const taxRate = parseFloat($(row).find('.tax-rate-input').val()) || 0;
      
      // Price Excl Tax = QTY * Unit Price
      const priceExclTax = qty * unitPrice;
      
      // Total Tax = Price Excl Tax * (Tax Rate / 100)
      const totalTax = priceExclTax * (taxRate / 100);
      
      // Price Incl Tax = Price Excl Tax + Total Tax
      const priceInclTax = priceExclTax + totalTax;
      
      // Shipping Fees = Price Incl Tax * 2%
      const shippingFees = priceInclTax * 0.02;
      
      // Total Price = Price Incl Tax + Shipping Fees
      const totalPrice = priceInclTax + shippingFees;
      
      $(row).find('.price-excl-tax').val(priceExclTax.toFixed(2));
      $(row).find('.total-tax').val(totalTax.toFixed(2));
      $(row).find('.price-incl-tax').val(priceInclTax.toFixed(2));
      $(row).find('.shipping-fees').val(shippingFees.toFixed(2));
      $(row).find('.total-price').val(totalPrice.toFixed(2));
    }

    // Remove item row
    function soRemoveItemRow(button) {
      if (confirm('Are you sure you want to remove this item?')) {
        button.closest('tr').remove();
      }
    }

    // Update all item rows with header data
    function updateAllItemRowsWithHeaderData() {
      const soID = document.getElementById('soSOID').value;
      const soDate = document.getElementById('soSODate').value;
      const customerID = document.getElementById('soCustomerID').value;
      const customerName = $('#soCustomerName').val();
      const county = document.getElementById('soCounty').value;
      const town = document.getElementById('soTown').value;
      const invoiceNum = document.getElementById('soInvoiceNum').value;
      
      $('#soItemsTableBody tr').each(function() {
        $(this).find('input').eq(0).val(soDate); // Date
        $(this).find('input').eq(1).val(soID); // SO ID
        $(this).find('input').eq(3).val(customerID); // Customer ID
        $(this).find('input').eq(4).val(customerName); // Customer Name
        $(this).find('input').eq(5).val(county); // County
        $(this).find('input').eq(6).val(town); // Town
        $(this).find('input').eq(7).val(invoiceNum); // Invoice Num
      });
    }

    // Watch for changes in header fields
    $('#soSODate, #soSOID, #soInvoiceNum').on('change', function() {
      updateAllItemRowsWithHeaderData();
    });

    // Save new SO
    async function soSaveNewSO() {
      // Validate header
      const soID = document.getElementById('soSOID').value.trim();
      const soDate = document.getElementById('soSODate').value.trim();
      const customerName = $('#soCustomerName').val();
      const customerID = document.getElementById('soCustomerID').value.trim();
      const county = document.getElementById('soCounty').value.trim();
      const town = document.getElementById('soTown').value.trim();
      const invoiceNum = document.getElementById('soInvoiceNum').value.trim();
      
      if (!soID || !soDate || !customerName || !invoiceNum) {
        alert('Please fill all required fields in SO Information');
        return;
      }
      
      // Collect items
      const items = [];
      let hasError = false;
      
      $('#soItemsTableBody tr').each(function() {
        const detailID = $(this).attr('data-detail-id');
        const itemName = $(this).find('.item-name-select').val();
        const itemID = $(this).find('.item-id').val();
        const itemType = $(this).find('.item-type').val();
        const itemCategory = $(this).find('.item-category').val();
        const itemSubcategory = $(this).find('.item-subcategory').val();
        const qty = parseInt($(this).find('.qty-input').val()) || 0;
        const unitPrice = parseFloat($(this).find('.unit-price').val()) || 0;
        const taxRate = parseFloat($(this).find('.tax-rate-input').val()) || 0;
        const priceExclTax = parseFloat($(this).find('.price-excl-tax').val()) || 0;
        const totalTax = parseFloat($(this).find('.total-tax').val()) || 0;
        const priceInclTax = parseFloat($(this).find('.price-incl-tax').val()) || 0;
        const shippingFees = parseFloat($(this).find('.shipping-fees').val()) || 0;
        const totalPrice = parseFloat($(this).find('.total-price').val()) || 0;
        
        if (!itemName || qty <= 0) {
          alert('Please fill all item details correctly');
          hasError = true;
          return false;
        }
        
        items.push({
          detail_id: detailID,
          date: soDate,
          so_id: soID,
          customer_id: customerID,
          customer_name: customerName,
          county: county,
          town: town,
          invoice_number: invoiceNum,
          item_id: itemID,
          item_type: itemType,
          item_category: itemCategory,
          item_subcategory: itemSubcategory,
          item_name: itemName,
          quantity_sold: qty,
          unit_price: unitPrice,
          tax_rate: taxRate,
          price_excluding_tax: priceExclTax,
          total_tax: totalTax,
          price_including_tax: priceInclTax,
          shipping_fees: shippingFees,
          total_sales_price: totalPrice
        });
      });
      
      if (hasError || items.length === 0) {
        if (items.length === 0) alert('Please add at least one item');
        return;
      }
      
      const soData = {
        so_id: soID,
        date: soDate,
        customer_id: customerID,
        customer_name: customerName,
        county: county,
        town: town,
        invoice_number: invoiceNum,
        items: items
      };
      
      showProcessing();
      try {
        const url = soIsEditMode ? '/api/sales/update/' : '/api/sales/add/';
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify(soData)
        });
        
        const result = await response.json();
        if (result.success) {
          alert(soIsEditMode ? 'Sales Order Updated Successfully' : 'Sales Order Saved Successfully');
          soCloseNewSOModal();
          await loadSalesOrders();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving SO:', error);
        alert('Failed to save sales order');
      } finally {
        hideProcessing();
      }
    }

    // View SO (Edit mode)
    async function soViewSO(soID) {
      showProcessing();
      try {
        const response = await fetch(`/api/sales/details/${soID}/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin'
        });
        
        const result = await response.json();
        if (result.success) {
          soIsEditMode = true;
          soCurrentSOID = soID;
          
          document.getElementById('soModalTitle').textContent = 'Update Sales Order';
          document.getElementById('soSaveBtn').textContent = 'Update SO';
          document.getElementById('soGenerateBtn').style.display = 'none';
          
          // Populate header
          const so = result.data.sales_order;
          document.getElementById('soSOID').value = so.so_id;
          document.getElementById('soSODate').value = so.date;
          $('#soCustomerName').val(so.customer_name).trigger('change');
          document.getElementById('soCustomerID').value = so.customer_id;
          document.getElementById('soCounty').value = so.county || '';
          document.getElementById('soTown').value = so.town || '';
          document.getElementById('soInvoiceNum').value = so.invoice_number;
          
          // Populate items
          document.getElementById('soItemsTableBody').innerHTML = '';
          const details = result.data.sales_details;
          
          for (const detail of details) {
            await soAddExistingItemRow(detail);
          }
          
          document.getElementById('soNewSOModal').style.display = 'block';
        } else {
          alert('Error loading SO details: ' + result.message);
        }
      } catch (error) {
        console.error('Error loading SO:', error);
        alert('Failed to load sales order');
      } finally {
        hideProcessing();
      }
    }

    // Add existing item row (for edit mode)
    async function soAddExistingItemRow(detail) {
      const tbody = document.getElementById('soItemsTableBody');
      const row = document.createElement('tr');
      row.setAttribute('data-detail-id', detail.detail_id);
      row.setAttribute('data-original-qty', detail.quantity_sold);
      
      let itemOptions = '<option value="">Select Item</option>';
      soInventoryItems.forEach(item => {
        const selected = item.name === detail.item_name ? 'selected' : '';
        itemOptions += `<option value="${item.name}" data-item-id="${item.id}" data-type="${item.type}" data-category="${item.category}" data-subcategory="${item.subcategory}" data-sale-price="${item.sale_price}" ${selected}>${item.name}</option>`;
      });
      
      row.innerHTML = `
        <td><input type="text" class="readonly" value="${detail.date}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.so_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.detail_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.customer_id}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.customer_name}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.county || ''}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.town || ''}" readonly></td>
        <td><input type="text" class="readonly" value="${detail.invoice_number}" readonly></td>
        <td><input type="text" class="readonly item-id" value="${detail.item_id}" readonly></td>
        <td><input type="text" class="readonly item-type" value="${detail.item_type}" readonly></td>
        <td><input type="text" class="readonly item-category" value="${detail.item_category}" readonly></td>
        <td><input type="text" class="readonly item-subcategory" value="${detail.item_subcategory}" readonly></td>
        <td><select class="item-name-select" style="min-width: 200px;">${itemOptions}</select></td>
        <td><input type="number" class="qty-input" min="1" value="${detail.quantity_sold}"></td>
        <td><input type="text" class="readonly unit-price" value="${parseFloat(detail.unit_price).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly price-excl-tax" value="${parseFloat(detail.price_excluding_tax).toFixed(2)}" readonly></td>
        <td><input type="number" class="tax-rate-input" step="0.01" min="0" value="${parseFloat(detail.tax_rate)}"></td>
        <td><input type="text" class="readonly total-tax" value="${parseFloat(detail.total_tax).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly price-incl-tax" value="${parseFloat(detail.price_including_tax).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly shipping-fees" value="${parseFloat(detail.shipping_fees).toFixed(2)}" readonly></td>
        <td><input type="text" class="readonly total-price" value="${parseFloat(detail.total_sales_price).toFixed(2)}" readonly></td>
        <td>
          <button class="remove-item-btn" onclick="soDeleteItemRow(this, '${detail.detail_id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
      
      $(row).find('.item-name-select').select2({
        placeholder: 'Select Item',
        allowClear: true,
        dropdownParent: $('#soNewSOModal')
      }).on('change', function() {
        soItemChanged(this);
      });
      
      $(row).find('.qty-input, .tax-rate-input').on('input', function() {
        soCalculateRowTotals(row);
      });
    }

    // Delete item row (in edit mode)
    async function soDeleteItemRow(button, detailID) {
      if (!confirm('Are you sure you want to delete this item? This will update inventory quantities.')) {
        return;
      }
      
      showProcessing();
      try {
        const response = await fetch('/api/sales/delete-detail/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify({ detail_id: detailID })
        });
        
        const result = await response.json();
        if (result.success) {
          button.closest('tr').remove();
          alert('Item deleted successfully');
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
      } finally {
        hideProcessing();
      }
    }

    // Search SOs
    function soSearchSOs() {
      showProcessing();
      const criteria = document.getElementById('soSearchCriteria').value;
      const query = document.getElementById('soSearchInput').value.toLowerCase().trim();
      
      if (!query) {
        soFilteredSOs = [...soAllSOs];
      } else {
        soFilteredSOs = soAllSOs.filter(so => {
          if (criteria === 'all') {
            return (
              so.so_id.toLowerCase().includes(query) ||
              so.customer_name.toLowerCase().includes(query) ||
              so.invoice_number.toLowerCase().includes(query) ||
              (so.receipt_status && so.receipt_status.toLowerCase().includes(query)) ||
              (so.shipping_status && so.shipping_status.toLowerCase().includes(query))
            );
          } else if (criteria === 'SO ID') {
            return so.so_id.toLowerCase().includes(query);
          } else if (criteria === 'Customer Name') {
            return so.customer_name.toLowerCase().includes(query);
          } else if (criteria === 'Invoice Num') {
            return so.invoice_number.toLowerCase().includes(query);
          } else if (criteria === 'Receipt Status') {
            return so.receipt_status && so.receipt_status.toLowerCase().includes(query);
          } else if (criteria === 'Shipping Status') {
            return so.shipping_status && so.shipping_status.toLowerCase().includes(query);
          }
          return true;
        });
      }
      
      soCurrentPage = 1;
      renderSOTable();
      
      if (soFilteredSOs.length === 0) {
        alert('No matching data found');
      }
      
      hideProcessing();
    }

    // Clear search
    function soClearSearch() {
      showProcessing();
      document.getElementById('soSearchInput').value = '';
      document.getElementById('soSearchCriteria').value = 'all';
      soFilteredSOs = [...soAllSOs];
      soCurrentPage = 1;
      renderSOTable();
      hideProcessing();
    }

    // Receipt Status Modal
    function soOpenReceiptStatusModal() {
      document.getElementById('soReceiptStatusModal').style.display = 'block';
      document.getElementById('soNewReceiptStatus').value = '';
    }

    function soCloseReceiptStatusModal() {
      document.getElementById('soReceiptStatusModal').style.display = 'none';
    }

    async function soSaveNewReceiptStatus() {
      const statusName = document.getElementById('soNewReceiptStatus').value.trim();
      
      if (!statusName) {
        alert('Please enter a receipt status');
        return;
      }
      
      showProcessing();
      try {
        const response = await fetch('/api/sales/receipt-statuses/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify({ status_name: statusName })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('Receipt Status Added Successfully');
          soCloseReceiptStatusModal();
          await loadReceiptStatuses();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving receipt status:', error);
        alert('Failed to add receipt status');
      } finally {
        hideProcessing();
      }
    }

    // Shipping Status Modal
    function soOpenShippingStatusModal() {
      document.getElementById('soShippingStatusModal').style.display = 'block';
      document.getElementById('soNewShippingStatus').value = '';
    }

    function soCloseShippingStatusModal() {
      document.getElementById('soShippingStatusModal').style.display = 'none';
    }

    async function soSaveNewShippingStatus() {
      const statusName = document.getElementById('soNewShippingStatus').value.trim();
      
      if (!statusName) {
        alert('Please enter a shipping status');
        return;
      }
      
      showProcessing();
      try {
        const response = await fetch('/api/purchases/shipping-statuses/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          credentials: 'same-origin',
          body: JSON.stringify({ status_name: statusName })
        });
        
        const result = await response.json();
        if (result.success) {
          alert('Shipping Status Added Successfully');
          soCloseShippingStatusModal();
          await loadShippingStatuses();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving shipping status:', error);
        alert('Failed to add shipping status');
      } finally {
        hideProcessing();
      }
    }

    // Utility functions
    function showProcessing() {
      document.getElementById('soProcessingOverlay').style.display = 'flex';
    }

    function hideProcessing() {
      document.getElementById('soProcessingOverlay').style.display = 'none';
    }


      // Close modal when clicking outside
    window.onclick = function(event) {
      const soModal = document.getElementById('soNewSOModal');
      const soReceiptStatusModal = document.getElementById('soReceiptStatusModal');
      const soShippingStatusModal = document.getElementById('soShippingStatusModal');
      
      if (event.target === soModal) {
        soCloseNewSOModal();
      }
      if (event.target === pmtModal) {
        soReceiptStatusModal();
      }
      if (event.target === shipModal) {
        soCloseShippingStatusModal();
      }
    }
  </script>

</body>
</html>